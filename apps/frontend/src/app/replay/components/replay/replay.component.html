<div class="replay-container" [class.print-mode]="isPrintMode" [class.booklet-mode]="isBookletMode" (window:keydown)="onKeyDown($event)">
  <cb-spinner [isLoaded]="isLoaded"></cb-spinner>

  @if (isBookletMode) {
    @if (isBookletMode && !!player && unitDef) {
      <coding-box-booklet-replay
        [bookletData]="bookletData"
        (unitChanged)="handleUnitChanged($event)">
      </coding-box-booklet-replay>
    }

    <div class="replay-content">
      <div class="unit-player-container">
        @if (!!player && unitDef) {
          @for (key of [reloadKey]; track key) {
            <coding-box-unit-player
              [unitDef]="unitDef"
              [unitPlayer]="player"
              [unitResponses]="responses"
              [pageId]="page"
              [printMode]="isPrintMode"
              (invalidPage)="checkPageError($event)">
            </coding-box-unit-player>
          }
        }
      </div>

      @if (codingScheme && currentVariableId) {
        <div class="code-selector-container">
          <app-code-selector
            [codingScheme]="codingScheme"
            [variableId]="currentVariableId"
            [preSelectedCodeId]="getPreSelectedCodeId(currentVariableId)"
            (codeSelected)="onCodeSelected($event)">
          </app-code-selector>
        </div>
      }
    </div>
  } @else {
    @if (!!player && unitDef) {
      @for (key of [reloadKey]; track key) {
        <coding-box-unit-player
          [unitDef]="unitDef"
          [unitPlayer]="player"
          [unitResponses]="responses"
          [pageId]="page"
          [printMode]="isPrintMode"
          (invalidPage)="checkPageError($event)">
        </coding-box-unit-player>
      }
    }
  }

  @if (isBookletMode && bookletData) {
    <div class="coding-progress">
      <div class="progress-info">
        <span class="progress-text">Coding Progress:</span>
        <span class="progress-numbers">{{ getCompletedCount() }}/{{ bookletData.units.length }}</span>
        <span class="progress-percentage">({{ getProgressPercentage() }}%)</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      @if (codingJobId) {
        <button
          mat-raised-button
          (click)="pauseCodingJob()"
          [disabled]="isPausingJob"
          class="pause-button">
          {{ isPausingJob ? 'Pausing...' : 'Pause Coding' }}
        </button>
      }
    </div>
  }

  @if (testPerson && unitId) {
    <div class="watermark">{{ testPerson }} - {{ unitId }}</div>
  }
</div>
