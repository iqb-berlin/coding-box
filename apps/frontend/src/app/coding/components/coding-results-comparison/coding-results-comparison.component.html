<div mat-dialog-content class="comparison-container">
  <div class="dialog-header">
    <h2>Kodierergebnisse vergleichen</h2>
    <span>Ergebnisse verschiedener Kodierer-Schulungen oder innerhalb einer Schulung gegenüberstellen</span>
  </div>

  <div class="mode-selection">
    <mat-radio-group [(ngModel)]="comparisonMode" (change)="onModeChange()">
      <mat-radio-button value="between-trainings">Zwischen Schulungen vergleichen</mat-radio-button>
      <mat-radio-button value="within-training">Innerhalb einer Schulung vergleichen</mat-radio-button>
    </mat-radio-group>
  </div>

  <div class="training-selection" *ngIf="comparisonMode === 'between-trainings'">
    <h3>Schulungen auswählen</h3>
    <div class="training-options">
      <mat-form-field>
        <mat-label>Suche</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput (keyup)="applyFilter($event)" placeholder="Schulungen filtern...">
      </mat-form-field>
    </div>
    <mat-checkbox *ngFor="let training of availableTrainings" [checked]="selectedTrainings.isSelected(training.id)"
      (change)="selectedTrainings.toggle(training.id); onTrainingSelectionChange();">
      {{ training.label }} ({{ training.jobsCount }} {{ training.jobsCount === 1 ? 'Job' : 'Jobs' }}, erstellt: {{
      training.created_at | date:'dd.MM.yyyy HH:mm' }})
    </mat-checkbox>
  </div>

  <div class="training-selection" *ngIf="comparisonMode === 'within-training'">
    <h3>Schulung auswählen</h3>
    <mat-form-field class="full-width-select">
      <mat-label>Schulung</mat-label>
      <mat-select [(ngModel)]="selectedTrainingForWithin" (selectionChange)="onTrainingForWithinChange()">
        <mat-option *ngFor="let training of availableTrainings" [value]="training.id">
          {{ training.label }} ({{ training.jobsCount }} {{ training.jobsCount === 1 ? 'Kodierer' : 'Kodierer' }},
          erstellt: {{ training.created_at | date:'dd.MM.yyyy HH:mm' }})
        </mat-option>
      </mat-select>
    </mat-form-field>

    <div class="coder-selection" *ngIf="availableCoders.length > 0">
      <mat-form-field class="full-width-select">
        <mat-label>Kodierer vergleichen</mat-label>
        <mat-select [formControl]="codersFormControl" multiple (selectionChange)="onCoderSelectionChange()">
          <mat-select-trigger>
            {{codersFormControl.value?.length || 0}} Kodierer ausgewählt
            <span *ngIf="(codersFormControl.value?.length || 0) === availableCoders.length"
              class="all-selected-hint">(Alle)</span>
          </mat-select-trigger>
          <mat-option *ngFor="let coder of availableCoders" [value]="coder.jobId">{{coder.coderName}}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>Lade Vergleichsdaten...</p>
  </div>

  <div class="comparison-table"
    *ngIf="!isLoading && ((comparisonMode === 'between-trainings' && comparisonData.length > 0) || (comparisonMode === 'within-training' && withinTrainingData.length > 0))">

    <div class="statistics-section" *ngIf="totalComparisons > 0">
      <h4>Kodierungsübereinstimmung</h4>
      <div class="statistics-row">
        <span>Gesamtvergleiche: <strong>{{ totalComparisons }}</strong></span>
        <span>Übereinstimmungen: <strong>{{ matchingComparisons }}</strong></span>
        <span>Übereinstimmungsrate: <strong>{{ matchingPercentage }}%</strong></span>
        <span
          *ngIf="comparisonMode === 'within-training' && kappaStatistics?.workspaceSummary?.meanAgreement !== null && kappaStatistics?.workspaceSummary?.meanAgreement !== undefined">
          Durchschnittliche Übereinstimmung: <strong>{{ kappaStatistics!.workspaceSummary.meanAgreement! |
            percent:'1.1-1' }}</strong>
          <small class="text-muted">({{ useWeightedMean ? 'gewichtet' : 'ungewichtet' }})</small>
        </span>
      </div>
    </div>

    <!-- Cohen's Kappa Statistics Section (within-training mode only) -->
    <div class="kappa-section" *ngIf="comparisonMode === 'within-training' && selectedTrainingForWithin">
      <div class="kappa-header" (click)="toggleKappaStatistics()">
        <h4>
          <mat-icon>{{ showKappaStatistics ? 'expand_less' : 'expand_more' }}</mat-icon>
          Cohen's Kappa (Interrater-Reliabilität)
        </h4>
        <button mat-icon-button class="toggle-button">
          <mat-icon>{{ showKappaStatistics ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      <div class="kappa-content" *ngIf="showKappaStatistics">
        <div class="loading-container" *ngIf="!kappaStatistics">
          <mat-progress-spinner mode="indeterminate" diameter="30"></mat-progress-spinner>
          <p>Berechne Cohen's Kappa...</p>
        </div>

        <div *ngIf="kappaStatistics" class="kappa-statistics">
          <!-- Weighted Mean Toggle -->
          <div class="weighting-toggle-container">
            <mat-slide-toggle [(ngModel)]="useWeightedMean" (change)="toggleWeightingMethod()" color="primary">
              Gewichteter Mittelwert (R eatPrep::meanKappa)
            </mat-slide-toggle>
            <mat-icon class="info-icon"
              matTooltip="Der gewichtete Mittelwert gewichtet jeden Kappa-Wert nach der Anzahl gültiger Paare, entsprechend der R-Implementierung: weighted.mean(dfr$kappa, dfr$N)"
              matTooltipPosition="right">
              info
            </mat-icon>
          </div>

          <!-- Calculation Level Toggle -->
          <div class="level-toggle-container">
            <mat-slide-toggle [(ngModel)]="useCodeLevel" (change)="toggleCalculationLevel()" color="primary">
              Kappa auf Ebene der Codes
            </mat-slide-toggle>
            <mat-icon class="info-icon"
              matTooltip="Code-Ebene: Unterscheidet zwischen allen Codes (inkl. Missing-Codes 6,8,9). Score-Ebene: Basiert auf Scores, wobei verschiedene Codes auf denselben Score abgebildet werden können."
              matTooltipPosition="right">
              info
            </mat-icon>
            <span class="level-indicator">
              ({{ useCodeLevel ? 'Code-Ebene' : 'Score-Ebene' }})
            </span>
          </div>

          <!-- Summary Statistics -->
          <div class="summary-stats">
            <div class="stat-card">
              <span class="stat-label">Durchschnittliches Kappa</span>
              <span class="stat-value kappa-value"
                [class.kappa-high]="(kappaStatistics.workspaceSummary.averageKappa ?? 0) >= 0.8"
                [class.kappa-moderate]="(kappaStatistics.workspaceSummary.averageKappa ?? 0) >= 0.6 && (kappaStatistics.workspaceSummary.averageKappa ?? 0) < 0.8"
                [class.kappa-fair]="(kappaStatistics.workspaceSummary.averageKappa ?? 0) >= 0.4 && (kappaStatistics.workspaceSummary.averageKappa ?? 0) < 0.6"
                [class.kappa-low]="(kappaStatistics.workspaceSummary.averageKappa ?? 0) < 0.4">
                {{ kappaStatistics.workspaceSummary.averageKappa !== null ?
                (kappaStatistics.workspaceSummary.averageKappa | number:'1.3-3') : 'N/A' }}
              </span>
              <span class="stat-sublabel">{{ kappaStatistics.workspaceSummary.weightingMethod === 'weighted' ?
                'Gewichtet' : 'Ungewichtet' }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Kodierer-Paare</span>
              <span class="stat-value">{{ kappaStatistics.workspaceSummary.totalCoderPairs }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Doppelt kodierte Antworten</span>
              <span class="stat-value">{{ kappaStatistics.workspaceSummary.totalDoubleCodedResponses }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Kodierer</span>
              <span class="stat-value">{{ kappaStatistics.workspaceSummary.codersIncluded }}</span>
            </div>
          </div>

          <!-- Detailed Coder Pair Statistics -->
          <div class="coder-pairs-details" *ngIf="kappaStatistics.variables.length > 0">
            <h5>Details nach Kodierer-Paaren</h5>
            <div class="pairs-container" *ngFor="let variable of kappaStatistics.variables">
              <div class="pair-card" *ngFor="let pair of variable.coderPairs">
                <div class="pair-header">
                  <strong>{{ pair.coder1Name }} ↔ {{ pair.coder2Name }}</strong>
                </div>
                <div class="pair-stats">
                  <div class="pair-stat">
                    <span class="pair-stat-label">Kappa:</span>
                    <span class="pair-stat-value kappa-value" [class.kappa-high]="(pair.kappa ?? 0) >= 0.8"
                      [class.kappa-moderate]="(pair.kappa ?? 0) >= 0.6 && (pair.kappa ?? 0) < 0.8"
                      [class.kappa-fair]="(pair.kappa ?? 0) >= 0.4 && (pair.kappa ?? 0) < 0.6"
                      [class.kappa-low]="(pair.kappa ?? 0) < 0.4">
                      {{ pair.kappa !== null ? (pair.kappa | number:'1.3-3') : 'N/A' }}
                    </span>
                  </div>
                  <div class="pair-stat">
                    <span class="pair-stat-label">Übereinstimmung:</span>
                    <span class="pair-stat-value">{{ (pair.agreement * 100) | number:'1.1-1' }}%</span>
                  </div>
                  <div class="pair-stat">
                    <span class="pair-stat-label">Gültige Paare:</span>
                    <span class="pair-stat-value">{{ pair.validPairs }} / {{ pair.totalItems }}</span>
                  </div>
                  <div class="pair-stat interpretation">
                    <span class="interpretation-badge">{{ pair.interpretation | translate }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
        <!-- Unit Name Column -->
        <ng-container matColumnDef="unitName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header=unitName>Aufgabe</th>
          <td mat-cell *matCellDef="let comparison">
            <strong>{{ comparison.unitName }}</strong>
          </td>
        </ng-container>

        <!-- Variable ID Column -->
        <ng-container matColumnDef="variableId">
          <th mat-header-cell *matHeaderCellDef mat-sort-header=variableId>Variable</th>
          <td mat-cell *matCellDef="let comparison">
            <code>{{ comparison.variableId }}</code>
          </td>
        </ng-container>

        <!-- Testperson Column -->
        <ng-container matColumnDef="testperson">
          <th mat-header-cell *matHeaderCellDef mat-sort-header=testperson>Testperson</th>
          <td mat-cell *matCellDef="let comparison">
            {{ comparison.testperson }}
          </td>
        </ng-container>

        <!-- Person Login Column -->
        <ng-container matColumnDef="personLogin">
          <th mat-header-cell *matHeaderCellDef mat-sort-header=personLogin>Person Login</th>
          <td mat-cell *matCellDef="let comparison">
            {{ comparison.personLogin }}
          </td>
        </ng-container>

        <!-- Person Code Column -->
        <ng-container matColumnDef="personCode">
          <th mat-header-cell *matHeaderCellDef mat-sort-header=personCode>Person Code</th>
          <td mat-cell *matCellDef="let comparison">
            {{ comparison.personCode }}
          </td>
        </ng-container>

        <!-- Person Group Column -->
        <ng-container matColumnDef="personGroup">
          <th mat-header-cell *matHeaderCellDef mat-sort-header=personGroup>Person Gruppe</th>
          <td mat-cell *matCellDef="let comparison">
            {{ comparison.personGroup }}
          </td>
        </ng-container>

        <!-- Match Column -->
        <ng-container matColumnDef="match">
          <th mat-header-cell *matHeaderCellDef>Übereinstimmung</th>
          <td mat-cell *matCellDef="let comparison"
            [class]="areCodesTheSame(comparison) ? 'match-status-match' : 'match-status-differ'">
            <mat-icon>{{ areCodesTheSame(comparison) ? 'check_circle' : 'cancel' }}</mat-icon>
          </td>
        </ng-container>

        <!-- Dynamic Training Columns (between trainings mode) -->
        <ng-container *ngFor="let trainingId of selectedTrainings.selected" [matColumnDef]="'training_' + trainingId">
          <th mat-header-cell *matHeaderCellDef>
            {{ getTrainingColumnName(trainingId) }}
          </th>
          <td mat-cell *matCellDef="let comparison"
            [class]="hasCodeOrScore(comparison, trainingId) ? 'has-data' : 'no-data'">
            <div class="code-display" *ngIf="hasCodeOrScore(comparison, trainingId)">
              <span class="code">Code: <strong>{{ getTrainingCode(comparison, trainingId) ?? '-' }}</strong></span>
              <span class="score">Score: {{ getTrainingScore(comparison, trainingId) ?? '-' }}</span>
            </div>
            <span class="no-code" *ngIf="!hasCodeOrScore(comparison, trainingId)">Nicht kodiert</span>
          </td>
        </ng-container>

        <!-- Dynamic Coder Columns (within training mode) -->
        <ng-container
          *ngIf="comparisonMode === 'within-training' && selectedTrainingForWithin && withinTrainingData.length > 0">
          <ng-container *ngFor="let coder of withinTrainingData[0].coders; trackBy: trackByCoder"
            [matColumnDef]="'coder_' + coder.jobId">
            <th mat-header-cell *matHeaderCellDef>
              {{ coder.coderName }}
            </th>
            <td mat-cell *matCellDef="let comparison"
              [class]="hasCoderCodeOrScore(comparison, coder.jobId) ? 'has-data' : 'no-data'">
              <div class="code-display" *ngIf="hasCoderCodeOrScore(comparison, coder.jobId)">
                <span class="code">Code: <strong>{{ getCoderCode(comparison, coder.jobId) ?? '-' }}</strong></span>
                <span class="score">Score: {{ getCoderScore(comparison, coder.jobId) ?? '-' }}</span>
              </div>
              <span class="no-code" *ngIf="!hasCoderCodeOrScore(comparison, coder.jobId)">Nicht kodiert</span>
            </td>
          </ng-container>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.codes-match]="areCodesTheSame(row)"
          [class.codes-differ]="!areCodesTheSame(row)"></tr>
      </table>

      <mat-paginator [pageSizeOptions]="[50, 100, 200, 500]" showFirstLastButtons></mat-paginator>
    </div>
  </div>

  <div class="no-data"
    *ngIf="!isLoading && comparisonMode === 'between-trainings' && comparisonData.length === 0 && selectedTrainings.selected.length < 2">
    <mat-icon>compare</mat-icon>
    <h4>Wählen Sie mindestens 2 Schulungen aus</h4>
    <p>Um Kodierergebnisse zu vergleichen, müssen mindestens 2 Schulungen ausgewählt werden.</p>
  </div>

  <div class="no-data"
    *ngIf="!isLoading && comparisonMode === 'within-training' && withinTrainingData.length === 0 && !selectedTrainingForWithin">
    <mat-icon>compare</mat-icon>
    <h4>Wählen Sie eine Schulung aus</h4>
    <p>Um Kodierergebnisse innerhalb einer Schulung zu vergleichen, müssen Sie eine Schulung auswählen.</p>
  </div>

  <div class="no-results"
    *ngIf="!isLoading && comparisonMode === 'between-trainings' && comparisonData.length === 0 && selectedTrainings.selected.length >= 2">
    <mat-icon>info</mat-icon>
    <h4>Keine gemeinsamen Daten gefunden</h4>
    <p>Die ausgewählten Schulungen haben keine gemeinsamen Einheiten/Variablen oder keine Kodierergebnisse.</p>
  </div>

  <div class="no-results"
    *ngIf="!isLoading && comparisonMode === 'within-training' && withinTrainingData.length === 0 && selectedTrainingForWithin">
    <mat-icon>info</mat-icon>
    <h4>Keine Daten gefunden</h4>
    <p>Die ausgewählte Schulung hat keine Kodierergebnisse oder alle Kodierer haben die gleichen Ergebnisse.</p>
  </div>
</div>


<div mat-dialog-actions align="end">
  <button mat-button (click)="dialogRef.close()">
    Schließen
  </button>
</div>