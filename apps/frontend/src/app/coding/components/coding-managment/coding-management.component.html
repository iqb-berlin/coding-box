<div class="fx-column-start-start fx-gap-10 coding-container">

  <div>
    <div class="fx-row-center-center-stretch fx-gap-20 action-buttons">
      @if (!showManualCoding) {
        <a mat-raised-button color="primary" (click)="onAutoCode()">
          <mat-icon>auto_fix_high</mat-icon>
          {{ 'coding-management.buttons.auto-code' | translate }}
        </a>
      }
      <a mat-raised-button [color]="showManualCoding ? 'accent' : 'primary'" (click)="toggleManualCoding()" >
        <mat-icon>edit</mat-icon>
        {{ showManualCoding ? ('coding-management.buttons.back-to-overview' | translate) : ('coding-management.buttons.manual-code' | translate) }}
      </a>
      @if (!showManualCoding) {
        <a mat-raised-button color="primary" (click)="fetchResponsesByStatus('6')">
          <mat-icon>refresh</mat-icon>
          {{ 'coding-management.buttons.manual-cases' | translate }}
        </a>
      }
      @if (!showManualCoding) {
        <a mat-raised-button color="primary" (click)="fetchCodingList()">
          <mat-icon>list</mat-icon>
          {{ 'coding-management.buttons.coding-list' | translate }}
        </a>
      }
      @if (!showManualCoding) {
        <a mat-raised-button color="primary" (click)="openExportCodingBook()">
          <mat-icon>book</mat-icon>
          {{ 'coding-management.buttons.codebook' | translate }}
        </a>
      }
      @if (!showManualCoding) {
        <a mat-raised-button color="primary" (click)="fetchVariableAnalysis()">
          <mat-icon>analytics</mat-icon>
          {{ 'coding-management.buttons.item-variable-analysis' | translate }}
        </a>
      }
      @if (!showManualCoding) {
        <a mat-raised-button color="primary" (click)="fetchUnitVariables()">
          <mat-icon>list_alt</mat-icon>
          {{ 'coding-management.buttons.coding-variables' | translate }}
        </a>
      }
    </div>
  </div>



  @if (!showManualCoding) {


    <div class="fx-column-start-start">
      <div class="content-row fx-column-start-start fx-gap-20">
        <div class="statistics-section">
          @if (!statisticsLoaded && !isLoadingStatistics) {
            <div class="statistics-placeholder">
              <div class="statistics-icon-container">
                <button mat-fab color="primary" (click)="fetchCodingStatistics()" [matTooltip]="'coding-management.tooltips.load-statistics' | translate" class="statistics-load-button">
                  <mat-icon>analytics</mat-icon>
                </button>
                <p class="statistics-placeholder-text">{{ 'coding-management.descriptions.load-statistics' | translate }}</p>
              </div>
            </div>
          }
          @if (statisticsLoaded && !isLoadingStatistics) {
            <div class="statistics-card">
              <div class="statistics-header">
                <div class="statistics-title-section">
                  <h2 class="section-title">{{ 'coding-management.titles.coding-statistics' | translate }}</h2>
                  <p class="section-description">{{ 'coding-management.descriptions.statistics-overview' | translate }}</p>
                </div>
                <div class="statistics-version-selector">
                  <mat-form-field appearance="outline" class="statistics-version-field">
                    <mat-label>{{ 'coding-management.statistics.coding-run-selector' | translate }}</mat-label>
                    <mat-select [(value)]="selectedStatisticsVersion" (selectionChange)="onStatisticsVersionChange()">
                      @for (option of codingRunOptions; track option.value) {
                        <mat-option [value]="option.value">
                          {{ option.label | translate }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
              <mat-divider></mat-divider>
              <div class="statistics-content">
                <div class="statistic-item">
                  <span class="statistic-label">{{ 'coding-management.statistics.total-responses' | translate }}</span>
                  <span class="statistic-value">{{ codingStatistics.totalResponses }}</span>
                </div>
                @for (status of getStatuses(); track status) {
                  <div class="statistic-item">
                    <span class="statistic-label">
                      @if (status === 'null') {
                        {{ 'coding-management.statistics.uncoded-responses' | translate }}
                        <mat-icon class="warning-icon" color="warn" [matTooltip]="'coding-management.statistics.missing-schemas' | translate">warning</mat-icon>
                      } @else {
                        {{ 'coding-management.statistics.responses-with-status' | translate:{status: mapStatusToString(Number(status))} }}
                      }
                    </span>
                    <span class="statistic-value">
                      {{ codingStatistics.statusCounts[status] }}
                      <span class="percentage">({{ getStatusPercentage(status) }}%)</span>
                    </span>
                    <a mat-button color="primary" (click)="fetchResponsesByStatus(status)" class="view-button">
                      <mat-icon>visibility</mat-icon>
                      {{ 'display' | translate }}
                    </a>
                  </div>
                }
              </div>
              <div class="statistics-actions">
                <a mat-raised-button color="primary" (click)="fetchCodingStatistics()">
                  <mat-icon>refresh</mat-icon>
                  {{ 'coding-management.buttons.update-statistics' | translate }}
                </a>
              </div>
            </div>
          }

          @if (isLoadingStatistics) {
            <div class="loading-container">
              <mat-spinner diameter="80" class="large-transparent-spinner"></mat-spinner>
              <p class="loading-text">{{ 'coding-management.loading.loading-statistics' | translate }}</p>
            </div>
          }
        </div>

        <div class="data-section">
          @if (isAutoCoding) {
            <div class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
              <p class="loading-text">{{ 'coding-management.loading.coding-responses' | translate }}</p>
            </div>
          }

          @if (isLoading && !isAutoCoding) {
            <div class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
              <p class="loading-text">{{ 'coding-management.loading.processing-data' | translate }}</p>
            </div>
          }

          @if (!isLoading && this.data.length > 0) {
            <div class="data-card">
              <div class="card-header">
                <h2 class="section-title">{{ 'coding-management.titles.coding-data' | translate }}</h2>
                @if (currentStatusFilter) {
                  <div class="current-status">
                    <h3>
                      @if (currentStatusFilter === 'null') {
                        {{ 'coding-management.statistics.uncoded-responses-title' | translate }}
                      } @else {
                        {{ 'coding-management.statistics.responses-with-status-title' | translate:{status: mapStatusToString(Number(currentStatusFilter))} }}
                      }
                    </h3>
                  </div>
                }
              </div>
              <mat-divider></mat-divider>
              <div class="table-container">
                <table mat-table [dataSource]="dataSource" matSort class="coding-table">
                  @for (column of displayedColumns; track column) {
                    <ng-container matColumnDef="{{ column }}">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ getColumnHeader(column) }} </th>
                      <td mat-cell *matCellDef="let element" [attr.colspan]="element.id === 0 ? displayedColumns.length : null">
                        @if (element.id === 0) {
                          <ng-container class="group-header">
                            <strong class="group-header-text">{{ element.unitname || element.variableid }}</strong>
                          </ng-container>
                        }
                        @if (element.id !== 0) {
                          @if (column === 'actions') {
                            <div class="action-buttons-container">
                              <button mat-icon-button color="primary" (click)="openReplay(element)" [matTooltip]="'coding-management.tooltips.view-in-replay' | translate" class="action-button">
                                <mat-icon>play_circle_filled</mat-icon>
                              </button>
                              <button mat-icon-button color="accent" (click)="getCodingSchemeRefFromUnit(element.unit.name)" [matTooltip]="'coding-management.tooltips.show-coding-schema' | translate" class="action-button">
                                <mat-icon>code</mat-icon>
                              </button>
                            </div>
                          } @else if (column === 'unitname') {
                            <span class="clickable-cell" (click)="showUnitXml(element.unit.name)" [matTooltip]="'coding-management.tooltips.show-unit-xml' | translate">
                              {{ element[column] }}
                            </span>
                          } @else {
                            <span [ngClass]="{'status-value': column === 'status' || column === 'codedstatus',
                                              'status-complete': (column === 'status' && getStatusString(element[column]) === 'CODING_COMPLETE') || (column === 'codedstatus' && element[column] === 'CODING_COMPLETE'),
                                              'status-incomplete': (column === 'status' && getStatusString(element[column]) === 'CODING_INCOMPLETE') || (column === 'codedstatus' && element[column] === 'CODING_INCOMPLETE'),
                                              'status-changed': column === 'status' && getStatusString(element[column]) === 'VALUE_CHANGED',
                                              'status-not-reached': column === 'status' && getStatusString(element[column]) === 'NOT_REACHED',
                                              'status-unset': column === 'status' && getStatusString(element[column]) === 'UNSET',
                                              'status-displayed': column === 'status' && getStatusString(element[column]) === 'DISPLAYED',
                                              'status-derive-error': column === 'status' && getStatusString(element[column]) === 'DERIVE_ERROR',
                                              'status-no-coding': column === 'status' && getStatusString(element[column]) === 'NO_CODING',
                                              'status-invalid': column === 'status' && getStatusString(element[column]) === 'INVALID',
                                              'status-coding-error': column === 'status' && getStatusString(element[column]) === 'CODING_ERROR',
                                              'status-partly-displayed': column === 'status' && getStatusString(element[column]) === 'PARTLY_DISPLAYED',
                                              'status-derive-pending': column === 'status' && getStatusString(element[column]) === 'DERIVE_PENDING',
                                              'status-intended-incomplete': column === 'status' && getStatusString(element[column]) === 'INTENDED_INCOMPLETE',
                                              'status-code-selection-pending': column === 'status' && getStatusString(element[column]) === 'CODE_SELECTION_PENDING'}">
                              @if (column === 'status') {
                                {{ getStatusString(element[column]) }}
                              } @else {
                                {{ element[column] }}
                              }
                            </span>
                          }
                        }
                      </td>
                    </ng-container>
                  }
                  <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row"></tr>
                </table>
                <mat-paginator
                  [length]="totalRecords"
                  [pageSize]="pageSize"
                  [pageIndex]="pageIndex"
                  [pageSizeOptions]="pageSizeOptions"
                  showFirstLastButtons
                  (page)="onPaginatorChange($event)"
                >
                </mat-paginator>
              </div>
            </div>
          }

          @if (!isLoading && this.data.length === 0) {
            <div class="empty-state">
              <mat-icon class="empty-icon">code</mat-icon>
              <h3>{{ 'coding-management.descriptions.no-data' | translate }}</h3>
              <p class="empty-text">{{ 'coding-management.descriptions.click-display' | translate }}</p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Manual Coding Management Content -->
  @if (showManualCoding) {
    <coding-box-coding-management-manual></coding-box-coding-management-manual>
  }

</div>
