<div class="test-person-coding-container">
  <mat-card class="code-test-persons-card">
    <mat-card-header>
      <mat-card-title>{{ 'test-person-coding.title' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="form-container">
        <div class="group-selection-container">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'test-person-coding.select-groups-label' | translate }}</mat-label>
            <mat-select multiple [(ngModel)]="selectedGroups">
              <mat-option *ngIf="groupsLoading" disabled>{{ 'test-person-coding.loading-groups' | translate }}</mat-option>
              <mat-option *ngIf="!groupsLoading && availableGroups.length === 0" disabled>{{ 'test-person-coding.no-groups' | translate }}</mat-option>
              <mat-option *ngFor="let group of availableGroups" [value]="group.groupName">
                {{ group.groupName }} ({{ group.testPersonCount }} Testpersonen, {{ group.responsesToCode }} Antworten)
              </mat-option>
            </mat-select>
            <mat-hint>{{ 'test-person-coding.select-groups-hint' | translate }}</mat-hint>
          </mat-form-field>
          <button mat-button type="button" [disabled]="availableGroups.length === 0" (click)="selectAllGroups()">
            <mat-icon>select_all</mat-icon>
            {{ 'test-person-coding.select-all-groups' | translate }}
          </button>
          <button mat-button type="button" [disabled]="selectedGroups.length === 0" (click)="deselectAllGroups()">
            <mat-icon>clear_all</mat-icon>
            {{ 'test-person-coding.deselect-all-groups' | translate }}
          </button>
        </div>

        <div class="autocoder-run-selection">
          <mat-radio-group [(ngModel)]="autoCoderRun" class="autocoder-radio-group">
            <mat-radio-button [value]="1">{{ 'test-person-coding.autocoder-run-selection.run-1' | translate }}</mat-radio-button>
            <mat-radio-button [value]="2">{{ 'test-person-coding.autocoder-run-selection.run-2' | translate }}</mat-radio-button>
          </mat-radio-group>
        </div>

        <div class="button-container">
          <button mat-raised-button color="primary" [disabled]="isLoading || selectedGroups.length === 0" (click)="codeTestPersons(selectedGroups.join(','))">
            <mat-icon>code</mat-icon>
            {{ 'test-person-coding.code-selected-groups' | translate }}
          </button>
          <button mat-button [disabled]="isLoading" (click)="codeAllTestPersons()">
            <mat-icon>group</mat-icon>
            {{ 'test-person-coding.code-all-test-persons' | translate }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="jobs-card">
    <mat-card-header>
      <mat-card-title>{{ 'test-person-coding.jobs.title' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="jobs-actions">
        <button mat-raised-button color="primary" (click)="loadAllJobs()" [disabled]="jobsLoading">
          <mat-icon>refresh</mat-icon>
          {{ 'test-person-coding.jobs.refresh' | translate }}
        </button>
      </div>

      <div class="loading-indicator" *ngIf="jobsLoading">
        <mat-spinner diameter="40"></mat-spinner>
        <span>{{ 'test-person-coding.jobs.loading' | translate }}</span>
      </div>

      <div class="table-container" *ngIf="allJobs.length > 0; else noJobs">
        <table mat-table [dataSource]="allJobs" class="mat-elevation-z8">
          <ng-container matColumnDef="jobId">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.job-id' | translate }}</th>
            <td mat-cell *matCellDef="let job">{{ job.jobId }}</td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.status' | translate }}</th>
            <td mat-cell *matCellDef="let job">
              <span class="status-value" [ngClass]="'status-' + job.status">{{ 'status-' + job.status | translate }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="progress">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.progress' | translate }}</th>
            <td mat-cell *matCellDef="let job">
              <div class="progress-container">
                <span class="progress-value">{{ job.progress }}%</span>
                <mat-progress-bar mode="determinate" [value]="job.progress"></mat-progress-bar>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.created' | translate }}</th>
            <td mat-cell *matCellDef="let job">{{ job.createdAt | date:'dd.MM.yyyy, HH:mm' }}</td>
          </ng-container>

          <ng-container matColumnDef="groups">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.groups' | translate }}</th>
            <td mat-cell *matCellDef="let job">
              <span *ngIf="job.groupNames" class="truncated-text" [matTooltip]="job.groupNames">
                {{ truncateText(job.groupNames, 30) }}
              </span>
              <span *ngIf="!job.groupNames" class="no-data">-</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="autoCoderRun">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.coding-run' | translate }}</th>
            <td mat-cell *matCellDef="let job">{{ job.autoCoderRun || 1 }}</td>
          </ng-container>

          <ng-container matColumnDef="duration">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.duration' | translate }}</th>
            <td mat-cell *matCellDef="let job">
              <span *ngIf="job.durationMs">{{ formatDuration(job.durationMs) }}</span>
              <span *ngIf="!job.durationMs && job.status === 'completed'">{{ 'test-person-coding.jobs.table.unknown' | translate }}</span>
              <span *ngIf="!job.durationMs && job.status !== 'completed'" class="no-data">-</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>{{ 'test-person-coding.jobs.table.actions' | translate }}</th>
            <td mat-cell *matCellDef="let job">
              <div class="job-actions">
                <button mat-icon-button color="warn" *ngIf="job.status === 'pending' || job.status === 'processing'"
                        (click)="cancelJob(job.jobId)" [matTooltip]="'test-person-coding.jobs.actions.cancel-job' | translate">
                  <mat-icon>cancel</mat-icon>
                </button>

                <button mat-icon-button color="primary" *ngIf="job.status === 'completed'"
                        (click)="showJobResult(job)" [matTooltip]="'test-person-coding.jobs.actions.show-result' | translate">
                  <mat-icon>visibility</mat-icon>
                </button>

                <button mat-icon-button color="warn" *ngIf="job.status === 'completed' || job.status === 'failed'"
                        (click)="deleteJob(job.jobId)" [matTooltip]="'test-person-coding.jobs.actions.delete-job' | translate">
                  <mat-icon>delete</mat-icon>
                </button>

                <!-- Error indicator for failed jobs -->
                <button mat-icon-button color="accent" *ngIf="job.status === 'failed'"
                        [matTooltip]="'test-person-coding.jobs.actions.error-tooltip' | translate:{error: job.error}">
                  <mat-icon>error</mat-icon>
                </button>

                <!-- Restart button for failed jobs -->
                <button mat-icon-button color="primary" *ngIf="job.status === 'failed'"
                        (click)="restartJob(job.jobId)" [matTooltip]="'test-person-coding.jobs.actions.restart-job' | translate">
                  <mat-icon>replay</mat-icon>
                </button>

                <!-- Test person indicator if available -->
                <span *ngIf="job.testPersonId" class="test-person-indicator" [matTooltip]="'test-person-coding.jobs.actions.test-person-id' | translate:{id: job.testPersonId}">
                  <mat-icon>person</mat-icon>
                  {{ job.testPersonId }}
                </span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['jobId', 'status', 'progress', 'createdAt', 'groups', 'autoCoderRun', 'duration', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['jobId', 'status', 'progress', 'createdAt', 'groups', 'autoCoderRun', 'duration', 'actions'];"></tr>
        </table>
      </div>

      <ng-template #noJobs>
        <div class="no-data" *ngIf="!jobsLoading">
          <mat-icon>work_off</mat-icon>
          <p>{{ 'test-person-coding.jobs.no-jobs' | translate }}</p>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>


  <mat-card class="job-status-card" *ngIf="activeJobId && jobStatus">
    <mat-card-header>
      <mat-card-title>{{ 'test-person-coding.current-job.title' | translate }}</mat-card-title>
      <mat-card-subtitle>{{ 'test-person-coding.current-job.subtitle' | translate }}: {{ activeJobId }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="job-status-content">
        <div class="status-row">
          <span class="status-label">{{ 'test-person-coding.current-job.status' | translate }}</span>
          <span class="status-value" [ngClass]="'status-' + jobStatus.status">{{ 'status-' + jobStatus.status | translate }}</span>
        </div>
        <div class="status-row">
          <span class="status-label">{{ 'test-person-coding.current-job.progress' | translate }}</span>
          <span class="status-value">{{ jobStatus.progress }}%</span>
        </div>
        <mat-progress-bar mode="determinate" [value]="jobStatus.progress"></mat-progress-bar>
        <div class="status-row" *ngIf="jobStatus.groupNames">
          <span class="status-label">{{ 'test-person-coding.current-job.groups' | translate }}</span>
          <span class="status-value truncated-text" [matTooltip]="jobStatus.groupNames">
            {{ truncateText(jobStatus.groupNames, 50) }}
          </span>
        </div>
        <div class="status-row" *ngIf="jobStatus.durationMs">
          <span class="status-label">{{ 'test-person-coding.current-job.duration' | translate }}</span>
          <span class="status-value">{{ formatDuration(jobStatus.durationMs) }}</span>
        </div>
        <div class="status-row" *ngIf="jobStatus.error">
          <span class="status-label">{{ 'test-person-coding.current-job.error' | translate }}</span>
          <span class="status-value error">{{ jobStatus.error }}</span>
        </div>
        <div class="button-container" *ngIf="jobStatus.status === 'pending' || jobStatus.status === 'processing'">
          <button mat-raised-button color="warn" (click)="cancelJob()">
            <mat-icon>cancel</mat-icon>
            {{ 'test-person-coding.current-job.cancel' | translate }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
