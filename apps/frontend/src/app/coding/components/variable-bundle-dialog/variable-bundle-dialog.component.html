<div class="dialog-container">
  <h2 class="dialog-title">{{ data.isEdit ? 'Variablenbündel bearbeiten' : 'Neues Variablenbündel erstellen' }}</h2>
  <mat-divider></mat-divider>

  <div class="dialog-content">
    <form [formGroup]="bundleGroupForm" (ngSubmit)="onSubmit()">
      <div class="form-section">
        <h3>Allgemeine Informationen</h3>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" placeholder="Name des Variablenbündels" required>
          @if (bundleGroupForm.get('name')?.invalid && bundleGroupForm.get('name')?.touched) {
            <mat-error>Name ist erforderlich</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Beschreibung</mat-label>
          <textarea matInput formControlName="description" placeholder="Beschreibung des Variablenbündels" rows="3"></textarea>
        </mat-form-field>
      </div>

      <div class="form-section">
        <h3>Variablen im Bündel</h3>
        <p class="section-description">Wählen Sie die Variablen aus, die diesem Bündel zugewiesen werden sollen:</p>

        <!-- Filter controls -->
        <div class="filter-container">
          <div class="filter-row">
            <mat-form-field class="filter-field">
              <mat-label>Aufgaben-ID Filter</mat-label>
              <input #unitNameFilterInput matInput [(ngModel)]="unitNameFilter" [ngModelOptions]="{standalone: true}" placeholder="Filter nach Aufgaben-ID">
              <button *ngIf="unitNameFilter" matSuffix mat-icon-button aria-label="Clear" (click)="unitNameFilter=''; unitNameFilterInput.value=''; applyFilter()">
                <mat-icon>close</mat-icon>
              </button>
            </mat-form-field>

            <mat-form-field class="filter-field">
              <mat-label>Variablen-ID Filter</mat-label>
              <input #variableIdFilterInput matInput [(ngModel)]="variableIdFilter" [ngModelOptions]="{standalone: true}" placeholder="Filter nach Variablen-ID">
              <button *ngIf="variableIdFilter" matSuffix mat-icon-button aria-label="Clear" (click)="variableIdFilter=''; variableIdFilterInput.value=''; applyFilter()">
                <mat-icon>close</mat-icon>
              </button>
            </mat-form-field>

            <!-- Filter button is now optional since filtering happens automatically with debounce -->
            <button mat-raised-button color="primary" (click)="applyFilter()">
              <mat-icon>filter_list</mat-icon>
              Filter anwenden
            </button>

            <button mat-raised-button (click)="clearFilters()">
              <mat-icon>clear</mat-icon>
              Filter zurücksetzen
            </button>
          </div>
        </div>

        @if (isLoadingVariableAnalysis) {
          <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p class="loading-text">Lade Variablen...</p>
          </div>
        }

        @if (!isLoadingVariableAnalysis && availableVariables.length > 0) {
          <div class="selection-count">
            {{ selectedVariables.selected.length }} von {{ dataSource.filteredData.length }} Variablen ausgewählt
          </div>

          <!-- Variables grid view -->
          <div class="variables-grid-container">
            <div class="variables-grid">
              @for (variable of dataSource.filteredData; track variable.unitName + variable.variableId) {
                <div class="variable-card"
                     [class.selected]="selectedVariables.isSelected(variable)"
                     (click)="selectedVariables.toggle(variable)">
                  <div class="variable-card-header">
                    <mat-checkbox [checked]="selectedVariables.isSelected(variable)"
                                  (click)="$event.stopPropagation()"
                                  (change)="$event ? selectedVariables.toggle(variable) : null">
                    </mat-checkbox>
                    <div class="variable-identifiers">
                      <div class="variable-id">
                        {{ variable.unitName }}_{{ variable.variableId }}
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        @if (!isLoadingVariableAnalysis && availableVariables.length === 0) {
          <div class="empty-state">
            <mat-icon class="empty-icon">analytics</mat-icon>
            <h3>Keine Variablen verfügbar</h3>
            <p class="empty-text">Es wurden keine Variablen gefunden. Bitte überprüfen Sie Ihre Filter oder versuchen Sie es später erneut.</p>
          </div>
        }
      </div>
    </form>
  </div>

  <div class="dialog-actions">
    <button mat-button (click)="onCancel()">Abbrechen</button>
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="bundleGroupForm.invalid || selectedVariables.selected.length === 0">
      {{ data.isEdit ? 'Speichern' : 'Erstellen' }}
    </button>
  </div>
</div>
