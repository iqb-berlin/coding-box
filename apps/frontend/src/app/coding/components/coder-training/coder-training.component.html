<div class="coder-training-container">
  <div class="training-header">
    <h2 class="section-title">
      <mat-icon>school</mat-icon>
      Kodierer-Schulung konfigurieren
    </h2>
    <button mat-icon-button (click)="onClose()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="training-content">
    <form [formGroup]="trainingForm">
      <!-- Training Label Section -->
      <div class="section">
        <h3 class="section-subtitle">Schulungs-Bezeichnung</h3>
        <mat-form-field appearance="outline" class="training-label-field">
          <mat-label>Bezeichnung für diese Kodierungs-Schulung</mat-label>
          <input matInput
                 formControlName="trainingLabel"
                 placeholder="z.B. Schulung vom 15.10.2025"
                 maxlength="255">
        </mat-form-field>
      </div>

      <!-- Coder Selection Section -->
      <div class="section">
        <div class="section-header">
          <h3 class="section-subtitle">Kodierer auswählen</h3>
          <div class="selection-controls">
            <button mat-button (click)="selectAllCoders()" type="button">
              <mat-icon>check_box</mat-icon>
              Alle auswählen
            </button>
            <button mat-button (click)="deselectAllCoders()" type="button">
              <mat-icon>check_box_outline_blank</mat-icon>
              Alle abwählen
            </button>
          </div>
        </div>

      <div class="coder-selection">
        <div class="coder-list" *ngIf="coders.length > 0; else noCodersTemplate">
          <div
            class="coder-item"
            *ngFor="let coder of coders; trackBy: trackByCoderId"
            [class.selected]="isCoderSelected(coder)"
            (click)="toggleCoderSelection(coder)">
            <mat-checkbox
              [checked]="isCoderSelected(coder)"
              (change)="toggleCoderSelection(coder)"
              (click)="$event.stopPropagation()">
            </mat-checkbox>
            <div class="coder-info">
              <div class="coder-name">{{coder.displayName || coder.name}}</div>
              <div class="coder-email" *ngIf="coder.email">{{coder.email}}</div>
              <div class="coder-jobs" *ngIf="coder.assignedJobs && coder.assignedJobs.length > 0">
                Zugewiesene Jobs: {{coder.assignedJobs.length}}
              </div>
            </div>
          </div>
        </div>

        <ng-template #noCodersTemplate>
          <div class="no-coders-message">
            <mat-icon>person_off</mat-icon>
            <p>Keine Kodierer gefunden</p>
          </div>
        </ng-template>
      </div>

      <div class="selection-summary" *ngIf="selectedCoders.size > 0">
        <p><strong>{{selectedCoders.size}}</strong> Kodierer ausgewählt</p>
      </div>
    </div>

    <!-- Variable Bundle Selection Section -->
    <div class="section">
      <div class="section-header">
        <h3 class="section-subtitle">
          Variablenbündel
          <span *ngIf="isLoadingBundles" class="loading-text">
            <mat-progress-spinner mode="indeterminate" diameter="16" style="display: inline-block; margin-left: 8px;"></mat-progress-spinner>
            Lade Variablenbündel...
          </span>
          <span *ngIf="!isLoadingBundles && availableBundles.length > 0" class="bundle-count">
            ({{availableBundles.length}} verfügbare Variablenbündel)
          </span>
        </h3>
      </div>

      <div *ngIf="!isLoadingBundles && availableBundles.length > 0" class="bundle-selection">
        <div class="bundle-select-container">
          <mat-form-field appearance="outline" class="bundle-select-field">
            <mat-label>Variablenbündel auswählen</mat-label>
            <mat-select placeholder="Variablenbündel auswählen" multiple [value]="selectedBundleArray" (selectionChange)="onBundleSelectionChange($event.value)">
              <mat-option *ngFor="let bundle of availableBundles" [value]="bundle.id"
                [matTooltip]="bundle.description || ''"
                matTooltipPosition="above">
                {{bundle.name}}
                <span class="bundle-variable-count"> ({{bundle.variables.length}} Variablen)</span>
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Selected Bundle Chips -->
        <div *ngIf="selectedBundleIds.size > 0" class="selected-bundles">
          <h5>Ausgewählte Variablenbündel:</h5>
          <mat-chip-set>
            <mat-chip
              *ngFor="let bundleId of selectedBundleIds"
              [removable]="true"
              (removed)="onBundleRemoved(bundleId)"
              matTooltip="Bundle entfernen">
              {{getBundleName(bundleId)}}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
          </mat-chip-set>
        </div>
      </div>

      <div *ngIf="!isLoadingBundles && availableBundles.length === 0" class="no-bundles-message">
        <mat-icon>inventory_2</mat-icon>
        <p>Keine Variablenbündel verfügbar</p>
      </div>
    </div>

    <!-- Variable Configuration Section -->
    <div class="section">
      <div class="section-header">
        <h3 class="section-subtitle">
          Variablen-Konfiguration
          <span *ngIf="isLoadingVariables" class="loading-text">
            <mat-progress-spinner mode="indeterminate" diameter="16" style="display: inline-block; margin-left: 8px;"></mat-progress-spinner>
            Lade verfügbare Variablen...
          </span>
          <span *ngIf="!isLoadingVariables && availableVariables.length > 0" class="variable-count">
            ({{availableVariables.length}} verfügbare Variablen)
          </span>
        </h3>
        <button mat-button (click)="addVariable()" type="button" [disabled]="isLoadingVariables">
          <mat-icon>add</mat-icon>
          Variable hinzufügen
        </button>
      </div>

      <div class="variable-config">
        <!-- Manual Variables -->
        <div *ngIf="groupedVariables.manual.length > 0">
          <h4 class="variable-section-title">Manuell hinzugefügte Variablen</h4>
          <div formArrayName="variables">
            <div
              class="variable-item"
              *ngFor="let item of groupedVariables.manual"
              [formGroupName]="item.index">

              <mat-form-field appearance="outline" class="variable-name-field">
                <mat-label>Variable auswählen</mat-label>
                <mat-select formControlName="variableId" placeholder="Variable auswählen" (selectionChange)="onVariableChange($event.value, item.index)">
                  <mat-option *ngFor="let variable of availableVariables" [value]="variable.variableId">
                    {{variable.unitName}} - {{variable.variableId}}
                  </mat-option>
                  <mat-option value="" *ngIf="availableVariables.length === 0">
                    Keine Variablen verfügbar
                  </mat-option>
                </mat-select>
                <input type="hidden" formControlName="unitId">
              </mat-form-field>

              <mat-form-field appearance="outline" class="sample-count-field">
                <mat-label>Anzahl Stichproben</mat-label>
                <input matInput
                       type="number"
                       formControlName="sampleCount"
                       min="1"
                       max="1000">
              </mat-form-field>

              <button
                mat-icon-button
                type="button"
                color="warn"
                (click)="removeVariable(item.index)"
                [disabled]="variablesFormArray.length === 1"
                class="remove-variable-button">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Bundle Variables -->
        <div *ngFor="let bundleGroup of groupedVariables.bundles" class="bundle-variable-group">
          <div class="bundle-header">
            <h4 class="bundle-title">
              <mat-icon>inventory_2</mat-icon>
              Bundle: {{bundleGroup.bundle.name}}
              <span class="bundle-variable-count-badge">({{bundleGroup.variables.length}} Variablen)</span>
            </h4>
            <div class="bundle-controls">
              <mat-form-field appearance="outline" class="bundle-sample-field">
                <mat-label>Stichproben pro Variable</mat-label>
                <input matInput
                       type="number"
                       [value]="getBundleSampleCount(bundleGroup.bundle.id)"
                       (input)="updateBundleSampleCount(bundleGroup.bundle.id, $any($event.target).value)"
                       min="1"
                       max="1000">
              </mat-form-field>
              <button mat-icon-button
                      color="warn"
                      (click)="removeBundle(bundleGroup.bundle.id)"
                      matTooltip="Bundle entfernen">
                <mat-icon>cancel</mat-icon>
              </button>
            </div>
          </div>

          <div formArrayName="variables" class="bundle-variables-list">
            <div
              class="variable-item bundle-variable-item"
              *ngFor="let item of bundleGroup.variables"
              [formGroupName]="item.index">

              <div class="variable-info">
                <mat-form-field appearance="outline" class="variable-name-field">
                  <mat-label>Variable</mat-label>
                  <input matInput
                         formControlName="variableId"
                         readonly
                         [matTooltip]="item.control.get('unitId')?.value + ' - ' + item.control.get('variableId')?.value">
                  <input type="hidden" formControlName="unitId">
                </mat-form-field>

                <mat-form-field appearance="outline" class="sample-count-field bundle-sample-display">
                  <mat-label>Stichproben</mat-label>
                  <input matInput
                         type="number"
                         formControlName="sampleCount"
                         readonly
                         [matTooltip]="'Aktueller Wert: ' + item.control.get('sampleCount')?.value + ' (gesetzt durch Bundle)'">
                  <mat-hint>Bundle gesteuert</mat-hint>
                </mat-form-field>
              </div>

              <button
                mat-icon-button
                type="button"
                color="warn"
                (click)="removeVariable(item.index)"
                [disabled]="variablesFormArray.length === 1"
                class="remove-variable-button">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    </form>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button
        mat-raised-button
        color="primary"
        (click)="onStartTraining()"
        [disabled]="!canStartTraining() || isLoading"
        class="start-training-button">
        <mat-icon *ngIf="!isLoading">play_arrow</mat-icon>
        <mat-progress-spinner mode="indeterminate" diameter="20" *ngIf="isLoading"></mat-progress-spinner>
        {{ isLoading ? 'Kodierungsaufträge werden erstellt...' : 'Kodierungsaufträge erstellen' }}
      </button>

      <button
        mat-button
        (click)="onClose()"
        [disabled]="isLoading"
        class="cancel-button">
        <mat-icon>cancel</mat-icon>
        Abbrechen
      </button>
    </div>

    <!-- Training Summary -->
    <div class="training-summary" *ngIf="selectedCoders.size > 0 && (variablesFormArray.length > 0 || availableBundles.length > 0)">
      <div class="summary-card">
        <h4>Schulungs-Übersicht</h4>
        <ul>
          <li>Ausgewählte Kodierer: <strong>{{selectedCoders.size}}</strong></li>
          <li *ngIf="variablesFormArray.length > 0">Konfigurierte Variablen: <strong>{{variablesFormArray.length}}</strong></li>
          <li *ngIf="variablesFormArray.length > 0">
            Gesamte Stichproben:
            <strong>{{getTotalSamples()}}</strong>
          </li>
          <li *ngIf="variablesFormArray.length === 0 && availableBundles.length > 0">
            Verfügbare Variablenbündel: <strong>{{availableBundles.length}}</strong>
          </li>
          <li *ngIf="variablesFormArray.length === 0 && availableBundles.length > 0">
            <em>Wählen Sie ein Variablenbündel aus, um Variablen hinzuzufügen</em>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-container">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      <p>Lade Kodierer...</p>
    </div>
  </ng-template>
</div>
