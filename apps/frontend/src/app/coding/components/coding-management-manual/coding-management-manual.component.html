<div class="fx-column-start-start fx-gap-10 coding-container">

  <div>
    <div class="fx-row-center-center-stretch fx-gap-20 action-buttons">
      <a mat-raised-button color="primary" (click)="externalCodingFileInput.click()" [disabled]="isLoading">
        <mat-icon>link</mat-icon>
        Externe Kodierung einbinden
      </a>
      <input #externalCodingFileInput type="file" style="display: none;" accept=".csv, .xlsx, .xls" (change)="onExternalCodingFileSelected($event)">
      <a mat-raised-button color="primary" (click)="openCoderTraining()">
        <mat-icon>school</mat-icon>
        Schulung starten
      </a>
      <a mat-raised-button color="primary" (click)="fileInput.click()" [disabled]="isLoading">
        <mat-icon>upload_file</mat-icon>
        Validierungs-Kodierliste
      </a>
      <input #fileInput type="file" style="display: none;" accept=".xlsx, .xls" (change)="onFileSelected($event)">
    </div>
  </div>

  <div *ngIf="validationProgress && (validationProgress.status === 'loading' || validationProgress.status === 'processing')"
       class="fx-column-start-start fx-gap-10 validation-progress">
    <div class="statistics-card">
      <h2 class="section-title">Validierung läuft</h2>
      <p class="section-description">
        {{validationProgress.message}}
      </p>
      <hr>
      <div class="progress-container">
        <mat-progress-bar mode="determinate" [value]="validationProgress.progress"></mat-progress-bar>
        <p class="progress-text">{{validationProgress.progress}}%</p>
      </div>
      <p class="progress-note">Sie können andere Aufgaben erledigen, während die Validierung im Hintergrund läuft.</p>
    </div>
  </div>

  <div *ngIf="validationProgress && validationProgress.status === 'error'"
       class="fx-column-start-start fx-gap-10 validation-error">
    <div class="statistics-card error-card">
      <h2 class="section-title">Fehler bei der Validierung</h2>
      <p class="section-description">
        {{validationProgress.message}}
      </p>
      <p *ngIf="validationProgress.error" class="error-details">
        {{validationProgress.error}}
      </p>
      <hr>
      <div class="error-actions">
        <button mat-button color="primary" (click)="fileInput.click()">
          <mat-icon>refresh</mat-icon>
          Erneut versuchen
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="validationResults && validationProgress && validationProgress.status === 'completed'"
       class="fx-column-start-start fx-gap-10 validation-results">
    <div class="statistics-card">
      <div class="fx-row-space-between-center fx-gap-10">
        <div>
          <h2 class="section-title">Validierungsergebnisse</h2>
          <p class="section-description">
            Insgesamt: {{validationResults.total}} |
            Fehlend: {{validationResults.missing}} |
            Seite {{validationResults.currentPage}} von {{validationResults.totalPages}}
          </p>
        </div>
        <div>
          <button mat-raised-button color="accent" (click)="downloadExcel()" [disabled]="isLoading || !validationCacheKey">
            <mat-icon>download</mat-icon>
            Als Excel herunterladen
          </button>
        </div>
      </div>
      <hr>

      <div class="fx-row-space-between-center fx-gap-10 pagination-controls" *ngIf="validationResults.totalPages > 1">
        <div class="fx-row-center-center fx-gap-10">
          <button mat-button [disabled]="!hasPreviousPage" (click)="previousPage()">
            <mat-icon>chevron_left</mat-icon>
            Vorherige
          </button>
          <span class="pagination-info">
            Seite {{currentPage}} von {{totalPages}}
          </span>
          <button mat-button [disabled]="!hasNextPage" (click)="nextPage()">
            Nächste
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

        <div class="fx-row-center-center fx-gap-10">
          <label for="pageSize">Einträge pro Seite:</label>
          <select id="pageSize" [value]="pageSize" (change)="changePageSize(+$any($event.target).value)">
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>

      <div class="validation-content" *ngIf="validationResults.results.length > 0">
        <table class="results-table">
          <thead>
            <tr>
              <th>{{ 'coding-management-manual.table.headers.unit-key' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.login-name' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.login-code' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.booklet-id' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.variable-id' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.status' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of validationResults.results" [class.missing]="result.status === 'MISSING'">
              <td>{{result.combination.unit_key}}</td>
              <td>{{result.combination.login_name}}</td>
              <td>{{result.combination.login_code}}</td>
              <td>{{result.combination.booklet_id}}</td>
              <td>{{result.combination.variable_id}}</td>
              <td>{{ 'coding-management-manual.table.status.' + (result.status === 'MISSING' ? 'missing' : 'present') | translate }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="fx-row-center-center fx-gap-10 pagination-controls" *ngIf="validationResults.totalPages > 1">
        <button mat-button [disabled]="!hasPreviousPage" (click)="previousPage()">
          <mat-icon>chevron_left</mat-icon>
          Vorherige
        </button>
        <span class="pagination-info">
          Seite {{currentPage}} von {{totalPages}}
        </span>
        <button mat-button [disabled]="!hasNextPage" (click)="nextPage()">
          Nächste
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="showComparisonTable && importResults"
       class="fx-column-start-start fx-gap-10 comparison-results">
    <div class="statistics-card">
      <div class="fx-row-space-between-center fx-gap-10">
        <div>
          <h2 class="section-title">Import-Vergleichstabelle</h2>
          <p class="section-description">
            {{importResults.message}} |
            Betroffene Zeilen: {{importResults.affectedRows.length}} |
            Seite {{comparisonCurrentPage}} von {{comparisonTotalPages}}
          </p>
        </div>
        <div class="fx-row-center-center fx-gap-10">
          <button mat-raised-button color="accent" (click)="downloadComparisonTable()" [disabled]="isLoading || !importResults.affectedRows.length">
            <mat-icon>download</mat-icon>
            Als Excel herunterladen
          </button>
          <button mat-button color="primary" (click)="closeComparisonTable()">
            <mat-icon>close</mat-icon>
            Schließen
          </button>
        </div>
      </div>
      <hr>

      <!-- Pagination controls for comparison table -->
      <div class="fx-row-space-between-center fx-gap-10 pagination-controls" *ngIf="comparisonTotalPages > 1">
        <div class="fx-row-center-center fx-gap-10">
          <button mat-button [disabled]="!comparisonHasPreviousPage" (click)="previousComparisonPage()">
            <mat-icon>chevron_left</mat-icon>
            Vorherige
          </button>
          <span class="pagination-info">
            Seite {{comparisonCurrentPage}} von {{comparisonTotalPages}}
          </span>
          <button mat-button [disabled]="!comparisonHasNextPage" (click)="nextComparisonPage()">
            Nächste
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>

        <div class="fx-row-center-center fx-gap-10">
          <label for="comparisonPageSize">Einträge pro Seite:</label>
          <select id="comparisonPageSize" [value]="comparisonPageSize" (change)="changeComparisonPageSize(+$any($event.target).value)">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
        </div>
      </div>

      <div class="comparison-content" *ngIf="importResults.affectedRows.length > 0">
        <table class="results-table">
          <thead>
            <tr>
              <th>{{ 'coding-management-manual.table.headers.unit-alias' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.variable-id' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.person-code' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.original-status' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.original-code' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.original-score' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.updated-status' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.updated-code' | translate }}</th>
              <th>{{ 'coding-management-manual.table.headers.updated-score' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of paginatedAffectedRows">
              <td>{{row.unitAlias}}</td>
              <td>{{row.variableId}}</td>
              <td>{{row.personCode || '-'}}</td>
              <td>{{row.originalCodedStatus}}</td>
              <td>{{row.originalCode || '-'}}</td>
              <td>{{row.originalScore || '-'}}</td>
              <td [class.updated]="row.updatedCodedStatus !== row.originalCodedStatus">
                {{row.updatedCodedStatus || '-'}}
              </td>
              <td [class.updated]="row.updatedCode !== row.originalCode">
                {{row.updatedCode || '-'}}
              </td>
              <td [class.updated]="row.updatedScore !== row.originalScore">
                {{row.updatedScore || '-'}}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Bottom pagination controls -->
      <div class="fx-row-center-center fx-gap-10 pagination-controls" *ngIf="comparisonTotalPages > 1">
        <button mat-button [disabled]="!comparisonHasPreviousPage" (click)="previousComparisonPage()">
          <mat-icon>chevron_left</mat-icon>
          Vorherige
        </button>
        <span class="pagination-info">
          Seite {{comparisonCurrentPage}} von {{comparisonTotalPages}}
        </span>
        <button mat-button [disabled]="!comparisonHasNextPage" (click)="nextComparisonPage()">
          Nächste
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>

      <div *ngIf="importResults.errors.length > 0" class="error-section">
        <h3>Fehler und Warnungen</h3>
        <ul>
          <li *ngFor="let error of importResults.errors" class="error-item">{{error}}</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="fx-row-space-between-stretch">
    <div class="statistics-card">
      <h2 class="section-title">Manuelle Kodierung planen</h2>
      <p class="section-description">Verwalten Sie Kodierjobs für die manuelle Kodierung von Antworten.</p>
      <hr>
      <div class="statistics-content">
        <div class="coding-jobs-container">
          <h3>Kodierjobs</h3>
          <coding-box-coding-jobs></coding-box-coding-jobs>
        </div>
        <div class="coder-training-list-container">
          <h3>Kodierer-Schulungen</h3>
          <coding-box-coder-trainings-list
            (onCreateTraining)="openCoderTraining()">
          </coding-box-coder-trainings-list>
        </div>
        <div class="variable-bundle-container">
          <h3>Variablenbündel</h3>
          <coding-box-variable-bundle-manager></coding-box-variable-bundle-manager>
        </div>
      </div>
    </div>
  </div>

  <!-- Coder Training Component -->
  <div *ngIf="showCoderTraining" class="coder-training-overlay">
    <div class="coder-training-modal">
      <coding-box-coder-training
        (close)="closeCoderTraining()"
        (startTraining)="onTrainingStart($event)">
      </coding-box-coder-training>
    </div>
  </div>
</div>
