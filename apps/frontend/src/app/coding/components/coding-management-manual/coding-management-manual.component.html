<div class="fx-column-start-stretch fx-gap-10 coding-container">

  <div
    *ngIf="validationProgress && (validationProgress.status === 'loading' || validationProgress.status === 'processing')"
    class="fx-column-start-start fx-gap-10 validation-progress">
    <div class="statistics-card">
      <h2 class="section-title">Validierung läuft</h2>
      <p class="section-description">
        {{validationProgress.message}}
      </p>
      <hr>
      <div class="progress-container">
        <mat-progress-bar mode="determinate" [value]="validationProgress.progress"></mat-progress-bar>
        <p class="progress-text">{{validationProgress.progress}}%</p>
      </div>
      <p class="progress-note">Sie können andere Aufgaben erledigen, während die Validierung im Hintergrund läuft.</p>
    </div>
  </div>

  <div *ngIf="validationProgress && validationProgress.status === 'error'"
    class="fx-column-start-start fx-gap-10 validation-error">
    <div class="statistics-card error-card">
      <h2 class="section-title">Fehler bei der Validierung</h2>
      <p class="section-description">
        {{validationProgress.message}}
      </p>
      <p *ngIf="validationProgress.error" class="error-details">
        {{validationProgress.error}}
      </p>
      <hr>
      <div class="error-actions">

      </div>
    </div>
  </div>

  <div class="fx-row-space-between-stretch">
    <div class="statistics-card">
      <div class="header-row">
        <div>
          <h2 class="section-title">Manuelle Kodierung planen</h2>
          <p class="section-description">Verwalten Sie Kodierjobs für die manuelle Kodierung von Antworten.</p>
        </div>
        <div class="header-actions">
          <button mat-stroked-button color="primary" (click)="externalCodingFileInput.click()" [disabled]="isLoading"
            matTooltip="{{ 'coding-management-manual.import.tooltip' | translate }}">
            <mat-icon>link</mat-icon>
            Externe Kodierung einbinden
          </button>
        </div>
      </div>
      <hr>

      <!-- Aggregation Configuration and Actions -->
      <div class="manual-coding-sections-container" *ngIf="responseAnalysis || isLoadingResponseAnalysis">
        <div class="aggregation-config" *ngIf="responseAnalysis || isLoadingResponseAnalysis">
          <h3 class="subsection-title">
            <mat-icon>settings</mat-icon>
            {{ 'coding-management-manual.duplicate-aggregation.config-title' | translate }}
          </h3>
          <p class="subsection-description">
            {{ 'coding-management-manual.duplicate-aggregation.config-description' | translate }}
          </p>
          <div class="analysis-summary">
            <div class="analysis-card">
              <div class="analysis-details">
                <div class="config-grid">
                  <div class="settings-control threshold-control">
                    <mat-form-field appearance="outline" class="density-compact">
                      <mat-label>{{ 'coding-management-manual.duplicate-aggregation.threshold-label' | translate
                        }}</mat-label>
                      <input matInput type="number" [(ngModel)]="duplicateAggregationThreshold"
                        (ngModelChange)="onThresholdChanged($event)" min="2" max="100" step="1">
                    </mat-form-field>

                    <div class="saving-indicator" *ngIf="isApplyingDuplicateAggregation">
                      <mat-spinner diameter="20"></mat-spinner>
                      <span>Speichern...</span>
                    </div>
                  </div>
                  <div class="settings-label">
                    <mat-icon class="label-icon">compare_arrows</mat-icon>
                    {{ 'coding-management-manual.response-matching.title' | translate }}
                    <span *ngIf="isLoadingMatchingMode || isSavingMatchingMode" class="loading-indicator">
                      <mat-spinner diameter="14"></mat-spinner>
                    </span>
                  </div>

                  <div class="settings-control matching-control">
                    <div class="checkbox-group">
                      <mat-checkbox [checked]="hasMatchingFlag(ResponseMatchingFlag.NO_AGGREGATION)"
                        (change)="toggleMatchingFlag(ResponseMatchingFlag.NO_AGGREGATION)"
                        [disabled]="isLoadingMatchingMode || isSavingMatchingMode" color="primary">
                        {{ 'coding-management-manual.response-matching.no-aggregation' | translate }}
                      </mat-checkbox>

                      <mat-checkbox [checked]="hasMatchingFlag(ResponseMatchingFlag.IGNORE_CASE)"
                        (change)="toggleMatchingFlag(ResponseMatchingFlag.IGNORE_CASE)"
                        [disabled]="isLoadingMatchingMode || isSavingMatchingMode || isMatchingOptionDisabled(ResponseMatchingFlag.IGNORE_CASE)"
                        color="primary">
                        {{ 'coding-management-manual.response-matching.ignore-case' | translate }}
                      </mat-checkbox>

                      <mat-checkbox [checked]="hasMatchingFlag(ResponseMatchingFlag.IGNORE_WHITESPACE)"
                        (change)="toggleMatchingFlag(ResponseMatchingFlag.IGNORE_WHITESPACE)"
                        [disabled]="isLoadingMatchingMode || isSavingMatchingMode || isMatchingOptionDisabled(ResponseMatchingFlag.IGNORE_WHITESPACE)"
                        color="primary">
                        {{ 'coding-management-manual.response-matching.ignore-whitespace' | translate }}
                      </mat-checkbox>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Response Analysis Section -->
        <div class="response-analysis-section statistics-section" [class.blurred-content]="isLoadingResponseAnalysis">
          <h3 class="subsection-title">
            <mat-icon>analytics</mat-icon>
            {{ 'coding-management-manual.response-analysis.title' | translate }}
            <button mat-icon-button (click)="refreshResponseAnalysis()"
              matTooltip="{{ 'coding-management-manual.response-analysis.refresh' | translate }}"
              [disabled]="isLoadingResponseAnalysis">
              <mat-icon>refresh</mat-icon>
            </button>
            <span *ngIf="isLoadingResponseAnalysis" class="loading-indicator">
              <mat-spinner diameter="16"></mat-spinner>
            </span>
          </h3>
          <p class="subsection-description">{{ 'coding-management-manual.response-analysis.description' | translate }}
          </p>

          <div *ngIf="responseAnalysis" class="analysis-summary">
            <!-- Empty Responses Summary -->
            <div class="analysis-card" [class.has-issues]="responseAnalysis.emptyResponses.total > 0">
              <div class="analysis-header" (click)="toggleEmptyResponsesDetails()">
                <div class="analysis-icon-title">
                  <mat-icon [class.warning-icon]="responseAnalysis.emptyResponses.total > 0">
                    {{ responseAnalysis.emptyResponses.total > 0 ? 'warning' : 'check_circle' }}
                  </mat-icon>
                  <div class="analysis-title-content">
                    <span class="analysis-title">{{ 'coding-management-manual.response-analysis.empty-responses' |
                      translate }}</span>
                    <span class="analysis-count" [class.warning-count]="responseAnalysis.emptyResponses.total > 0">
                      {{ responseAnalysis.emptyResponses.total }}
                    </span>
                  </div>
                </div>
                <mat-icon class="expand-icon">{{ showEmptyResponsesDetails ? 'expand_less' : 'expand_more' }}</mat-icon>
              </div>
              <div *ngIf="showEmptyResponsesDetails && responseAnalysis.emptyResponses.total > 0"
                class="analysis-details">
                <div class="table-responsive">
                  <table class="analysis-table">
                    <thead>
                      <tr>
                        <th>{{ 'coding-management-manual.response-analysis.table.unit' | translate }}</th>
                        <th>{{ 'coding-management-manual.response-analysis.table.variable' | translate }}</th>
                        <th>{{ 'coding-management-manual.response-analysis.table.person' | translate }}</th>
                        <th>{{ 'coding-management-manual.response-analysis.table.booklet' | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of responseAnalysis.emptyResponses.items">
                        <td>{{ item.unitAlias || item.unitName }}</td>
                        <td>{{ item.variableId }}</td>
                        <td>{{ item.personLogin }}{{ item.personCode ? ' (' + item.personCode + ')' : '' }}</td>
                        <td>{{ item.bookletName }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <mat-paginator [length]="responseAnalysis.emptyResponses.total"
                  [pageSize]="emptyPageSize"
                  [pageSizeOptions]="[5, 10, 25, 50, 100]"
                  [pageIndex]="emptyPageIndex"
                  (page)="onEmptyPageChange($event)"
                  aria-label="Select page of empty responses">
                </mat-paginator>
                <div class="analysis-actions">
                  <button mat-stroked-button color="primary" (click)="onApplyEmptyResponseCoding()"
                    [disabled]="isApplyingEmptyCoding"
                    [matTooltip]="'coding-management-manual.response-analysis.apply-empty-coding-tooltip' | translate">
                    <mat-icon *ngIf="!isApplyingEmptyCoding">flash_on</mat-icon>
                    <mat-spinner *ngIf="isApplyingEmptyCoding" diameter="20"></mat-spinner>
                    {{ 'coding-management-manual.response-analysis.apply-empty-coding-button' | translate }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Duplicate Values Summary -->
            <div class="analysis-card" [class.has-issues]="responseAnalysis.duplicateValues.total > 0">
              <div class="analysis-header" (click)="toggleDuplicateValuesDetails()">
                <div class="analysis-icon-title">
                  <mat-icon [class.warning-icon]="responseAnalysis.duplicateValues.total > 0">
                    {{ responseAnalysis.duplicateValues.total > 0 ? 'content_copy' : 'check_circle' }}
                  </mat-icon>
                  <div class="analysis-title-content">
                    <span class="analysis-title">
                      {{ 'coding-management-manual.response-analysis.duplicate-values' | translate }}
                      <span *ngIf="responseAnalysis.duplicateValues.isAggregationApplied"
                        class="aggregation-applied-badge">
                        <mat-icon>layers</mat-icon>
                        {{ 'coding-management-manual.duplicate-aggregation.is-applied' | translate }}
                      </span>
                    </span>
                    <span class="analysis-count" [class.warning-count]="responseAnalysis.duplicateValues.total > 0">
                      {{ responseAnalysis.duplicateValues.total }} {{
                      'coding-management-manual.response-analysis.groups'
                      | translate }}
                      ({{ responseAnalysis.duplicateValues.totalResponses }} {{
                      'coding-management-manual.response-analysis.responses' | translate }})
                    </span>
                  </div>
                </div>
                <mat-icon class="expand-icon">{{ showDuplicateValuesDetails ? 'expand_less' : 'expand_more'
                  }}</mat-icon>
              </div>

              <div *ngIf="showDuplicateValuesDetails && responseAnalysis.duplicateValues.total > 0"
                class="analysis-details">
                <div *ngFor="let group of responseAnalysis.duplicateValues.groups" class="duplicate-group">
                  <div class="duplicate-group-header">
                    <strong>{{ group.unitAlias || group.unitName }}</strong> / {{ group.variableId }}
                    <span class="duplicate-value">"{{ group.normalizedValue | slice:0:50 }}{{
                      group.normalizedValue.length
                      > 50 ? '...' : '' }}"</span>
                    <span class="occurrence-count">({{ group.occurrences.length }}x)</span>
                  </div>
                  <ul class="occurrence-list">
                    <li *ngFor="let occ of group.occurrences | slice:0:5">
                      {{ occ.personLogin }}{{ occ.personCode ? ' (' + occ.personCode + ')' : '' }} - {{ occ.bookletName
                      }}
                    </li>
                    <li *ngIf="group.occurrences.length > 5" class="more-occurrences">
                      +{{ group.occurrences.length - 5 }} {{ 'coding-management-manual.response-analysis.more' |
                      translate
                      }}
                    </li>
                  </ul>
                </div>

                <mat-paginator [length]="responseAnalysis.duplicateValues.total"
                  [pageSize]="duplicatePageSize"
                  [pageSizeOptions]="[5, 10, 20, 50, 100]"
                  [pageIndex]="duplicatePageIndex"
                  (page)="onDuplicatePageChange($event)"
                  aria-label="Select page of duplicate groups">
                </mat-paginator>
              </div>
            </div>

            <p class="analysis-timestamp">
              <mat-icon>schedule</mat-icon>
              {{ 'coding-management-manual.response-analysis.last-updated' | translate }}: {{
              responseAnalysis.analysisTimestamp | date:'medium' }}
            </p>

            <div *ngIf="!responseAnalysis && !isLoadingResponseAnalysis" class="no-analysis-data">
              <mat-icon>info</mat-icon>
              <span>{{ 'coding-management-manual.response-analysis.no-data' | translate }}</span>
            </div>
          </div>

          <!-- Loading Overlay for Response Analysis -->
          <div *ngIf="isLoadingResponseAnalysis" class="loading-overlay">
            <div class="loading-content">
              <mat-spinner diameter="40"></mat-spinner>
              <div class="loading-text">{{ 'coding-management-manual.loading.response-analysis' | translate }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="statistics-content">
        <!-- Coding Progress Overview -->
        <div *ngIf="codingProgressOverview" class="coding-progress-section statistics-section"
          [class.blurred-content]="isLoadingCodingProgress">
          <div class="statistics-card">
            <h2 class="section-title">Kodierungsfortschritt</h2>
            <div class="coverage-stats">
              <div class="stat-item">
                <span class="stat-label">Gesamt zu kodierende Fälle:</span>
                <span class="stat-value">{{codingProgressOverview.totalCasesToCode}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Abgeschlossene Fälle:</span>
                <span class="stat-value covered">{{codingProgressOverview.completedCases}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Ausstehende Fälle:</span>
                <span class="stat-value missing">{{codingProgressOverview.totalCasesToCode -
                  codingProgressOverview.completedCases}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Fertigstellungsrate:</span>
                <span class="stat-value percentage">{{codingProgressOverview.completionPercentage |
                  number:'1.1-1'}}%</span>
              </div>
            </div>
            <div class="coverage-bar">
              <div class="coverage-fill" [style.width.%]="codingProgressOverview.completionPercentage"></div>
            </div>
          </div>
          <div *ngIf="isLoadingCodingProgress" class="loading-overlay">
            <div class="loading-content">
              <mat-spinner diameter="40"></mat-spinner>
              <div class="loading-text">{{ 'coding-management-manual.loading.coding-progress' | translate }}</div>
            </div>
          </div>
        </div>

        <div class="job-definitions-container">
          <coding-box-coding-job-definitions (bulkCreationCompleted)="reloadCodingJobsList()"
            (jobDefinitionChanged)="onJobDefinitionChanged()"></coding-box-coding-job-definitions>
        </div>

        <!-- Variable Coverage Statistics -->
        <div *ngIf="variableCoverageOverview" class="variable-coverage-section statistics-section"
          [class.blurred-content]="isLoadingVariableCoverage">
          <div class="statistics-card">
            <h2 class="section-title">
              Variablenabdeckung
              <button mat-icon-button (click)="refreshAllStatistics()" matTooltip="Statistiken manuell aktualisieren">
                <mat-icon>refresh</mat-icon>
              </button>
              <span *ngIf="variableCoverageOverview.conflictedVariables > 0" class="conflict-badge"
                matTooltip="Es gibt Konflikte bei der Variablenzuordnung">
                <mat-icon>warning</mat-icon>
                {{variableCoverageOverview.conflictedVariables}} Konflikte
              </span>
            </h2>

            <!-- Overall Coverage Stats -->
            <div class="coverage-stats">
              <div class="stat-item">
                <span class="stat-label">Gesamt Variablen:</span>
                <span class="stat-value">{{variableCoverageOverview.totalVariables}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Abgedeckte Variablen:</span>
                <span class="stat-value covered">{{variableCoverageOverview.coveredVariables}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Fehlende Variablen:</span>
                <span class="stat-value missing">{{variableCoverageOverview.missingVariables}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Vollständig abgedeckt:</span>
                <span class="stat-value covered">{{variableCoverageOverview.fullyAbgedeckteVariablen}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Partiell abgedeckt:</span>
                <span class="stat-value partial">{{variableCoverageOverview.partiallyAbgedeckteVariablen}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Abdeckungsrate:</span>
                <span class="stat-value percentage">{{variableCoverageOverview.coveragePercentage |
                  number:'1.1-1'}}%</span>
              </div>
            </div>

            <!-- Status Breakdown -->
            <div class="status-breakdown">
              <h3 class="breakdown-title">Abdeckung nach Status</h3>
              <div class="status-stats">
                <div class="status-item draft">
                  <mat-icon class="status-icon">edit</mat-icon>
                  <div class="status-content">
                    <span class="status-label">Entwurf:</span>
                    <span class="status-value">{{variableCoverageOverview.coveredByDraft}}</span>
                  </div>
                </div>
                <div class="status-item pending">
                  <mat-icon class="status-icon">schedule</mat-icon>
                  <div class="status-content">
                    <span class="status-label">Warten auf Genehmigung:</span>
                    <span class="status-value">{{variableCoverageOverview.coveredByPendingReview}}</span>
                  </div>
                </div>
                <div class="status-item approved">
                  <mat-icon class="status-icon">check_circle</mat-icon>
                  <div class="status-content">
                    <span class="status-label">Genehmigt:</span>
                    <span class="status-value">{{variableCoverageOverview.coveredByApproved}}</span>
                  </div>
                </div>
                <div class="status-item conflict" *ngIf="variableCoverageOverview.conflictedVariables > 0">
                  <mat-icon class="status-icon">error</mat-icon>
                  <div class="status-content">
                    <span class="status-label">Konflikte:</span>
                    <span class="status-value">{{variableCoverageOverview.conflictedVariables}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Conflicts Details -->
            <div class="conflicts-section" *ngIf="variableCoverageOverview.coverageByStatus.conflicted.length > 0">
              <h3 class="conflicts-title">
                <mat-icon>warning</mat-icon>
                Variablenkonflikte
              </h3>
              <div class="conflicts-list">
                <div *ngFor="let conflict of variableCoverageOverview.coverageByStatus.conflicted"
                  class="conflict-item">
                  <div class="conflict-variable">
                    <mat-icon>code</mat-icon>
                    <span>{{conflict.variableKey}}</span>
                  </div>
                  <div class="conflict-definitions">
                    <span class="conflict-label">Zugeordnet zu:</span>
                    <span *ngFor="let def of conflict.conflictingDefinitions; let last = last"
                      class="conflict-definition">
                      Definition #{{def.id}} ({{getStatusLabel(def.status)}}){{!last ? ', ' : ''}}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="coverage-bar">
              <div class="coverage-fill" [style.width.%]="variableCoverageOverview.coveragePercentage"></div>
            </div>
          </div>
          <div *ngIf="isLoadingVariableCoverage" class="loading-overlay">
            <div class="loading-content">
              <mat-spinner diameter="40"></mat-spinner>
              <div class="loading-text">{{ 'coding-management-manual.loading.variable-coverage' | translate }}</div>
            </div>
          </div>
        </div>

        <div class="coding-jobs-container">
          <h3>Kodierjobs</h3>
          <coding-box-coding-jobs (jobsChanged)="onJobDefinitionChanged()"></coding-box-coding-jobs>
        </div>

        <!-- Case Coverage Statistics -->
        <div *ngIf="caseCoverageOverview" class="case-coverage-section statistics-section"
          [class.blurred-content]="isLoadingCaseCoverage">
          <div class="statistics-card">
            <h2 class="section-title">Fälle in Kodierjobs</h2>
            <div class="coverage-stats">
              <div class="stat-item">
                <span class="stat-label">Gesamt zu kodierende Fälle:</span>
                <span class="stat-value">{{caseCoverageOverview.totalCasesToCode}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Fälle in Jobs:</span>
                <span class="stat-value covered">{{caseCoverageOverview.casesInJobs}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Doppelt kodierte Fälle:</span>
                <span class="stat-value">{{caseCoverageOverview.doubleCodedCases}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Einfach kodierte Fälle:</span>
                <span class="stat-value">{{caseCoverageOverview.singleCodedCases}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Nicht zugewiesene Fälle:</span>
                <span class="stat-value missing">{{caseCoverageOverview.unassignedCases}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Abdeckungsrate:</span>
                <span class="stat-value percentage">{{caseCoverageOverview.coveragePercentage |
                  number:'1.1-1'}}%</span>
              </div>
            </div>
            <div class="coverage-bar">
              <div class="coverage-fill" [style.width.%]="caseCoverageOverview.coveragePercentage"></div>
            </div>
          </div>
          <div *ngIf="isLoadingCaseCoverage" class="loading-overlay">
            <div class="loading-content">
              <mat-spinner diameter="40"></mat-spinner>
              <div class="loading-text">{{ 'coding-management-manual.loading.case-coverage' | translate }}</div>
            </div>
          </div>
        </div>

        <!-- Applied Results Section -->
        <div *ngIf="appliedResultsOverview" class="applied-results-section">
          <div class="statistics-card">
            <h2 class="section-title">{{ 'applied-results-overview.title' | translate }}</h2>
            <div class="coverage-stats">
              <div class="stat-item">
                <span class="stat-label">{{ 'applied-results-overview.coding-incomplete' | translate }}</span>
                <span class="stat-value">{{appliedResultsOverview.totalIncompleteResponses}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">{{ 'applied-results-overview.applied-results' | translate }}</span>
                <span class="stat-value covered">{{appliedResultsOverview.appliedResponses}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">{{ 'applied-results-overview.remaining' | translate }}</span>
                <span class="stat-value missing">{{appliedResultsOverview.remainingResponses}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">{{ 'applied-results-overview.completion-progress' | translate }}</span>
                <span class="stat-value percentage">{{appliedResultsOverview.completionPercentage |
                  number:'1.1-1'}}%</span>
              </div>
            </div>
            <div class="coverage-bar">
              <div class="coverage-fill" [style.width.%]="appliedResultsOverview.completionPercentage"></div>
            </div>
          </div>
        </div>

        <div class="coder-training-list-container">
          <h3>Kodierer-Schulungen</h3>
          <coding-box-coder-trainings-list (onCreateTraining)="openCoderTraining()"
            (onEditTraining)="openTrainingEdit($event)">
          </coding-box-coder-trainings-list>
        </div>
        <div class="variable-bundle-container">
          <h3>Variablenbündel</h3>
          <coding-box-variable-bundle-manager></coding-box-variable-bundle-manager>
        </div>
      </div>
    </div>



    <input #externalCodingFileInput type="file" style="display: none;" accept=".csv, .xlsx, .xls"
      (change)="onExternalCodingFileSelected($event)">

    <!-- Coder Training Component -->
    <div *ngIf="showCoderTraining" class="coder-training-overlay">
      <div class="coder-training-modal">
        <coding-box-coder-training [editTraining]="editTraining" (close)="closeCoderTraining()"
          (startTraining)="onTrainingStart($event)">
        </coding-box-coder-training>
      </div>
    </div>
  </div>
</div>