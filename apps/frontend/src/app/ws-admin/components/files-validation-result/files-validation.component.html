<mat-dialog-content>
  @if (data && data.testTakersBookletsValidation) {
    <div class="validation-card global-booklet-testtakers-check-card" [class.complete]="data.testTakersBookletsValidation.complete" [class.incomplete]="!data.testTakersBookletsValidation.complete">
      <h4>
        <mat-icon class="section-icon">rule_folder</mat-icon>
        {{ 'ws-admin.validation-testtakers-booklets' | translate }}
      </h4>
      <p class="status-row">
        Status:
        @if (data.testTakersBookletsValidation.complete) {
          <span class="status-complete">
            <mat-icon class="status-icon">check_circle</mat-icon>
            {{ 'ws-admin.validation-complete' | translate }}
          </span>
        }
        @if (!data.testTakersBookletsValidation.complete) {
          <span class="status-incomplete">
            <mat-icon class="status-icon">error</mat-icon>
            {{ 'ws-admin.validation-incomplete' | translate }}
          </span>
        }
      </p>
      @if (!data.testTakersBookletsValidation.complete && data.testTakersBookletsValidation.missingBookletsByTesttakers) {
        <div class="missing-items">
          <p>
            <mat-icon class="missing-icon">warning_amber</mat-icon>
            {{ 'ws-admin.validation-booklets-missing-testtakers' | translate }}:
          </p>
          <ul>
            @for (testTaker of objectKeys(data.testTakersBookletsValidation.missingBookletsByTesttakers); track testTaker) {
              <li>
                <strong>{{ testTaker }}:</strong>
                <ul>
                  @for (booklet of data.testTakersBookletsValidation.missingBookletsByTesttakers[testTaker]; track booklet) {
                    <li>
                      {{ booklet }}
                    </li>
                  }
                </ul>
              </li>
            }
          </ul>
        </div>
      }
      @if (data.testTakersBookletsValidation.complete) {
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-booklets-in-testtakers-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (data && data.bookletsInTestTakersValidation) {
    <div class="validation-card global-booklet-testtakers-check-card" [class.complete]="data.bookletsInTestTakersValidation.complete" [class.incomplete]="!data.bookletsInTestTakersValidation.complete">
      @if (!data.bookletsInTestTakersValidation.complete && data.bookletsInTestTakersValidation.missing && data.bookletsInTestTakersValidation.missing.length > 0) {
        <div class="missing-items-header">
          <p>
            <mat-icon class="missing-icon">warning_amber</mat-icon>
            {{ 'ws-admin.validation-booklets-missing-testtakers' | translate }}:
          </p>
          <button mat-raised-button color="warn" (click)="deleteAllUnusedBooklets()">
            <mat-icon>delete_sweep</mat-icon>
            {{ 'ws-admin.delete-all' | translate }}
          </button>
        </div>
        <div class="missing-items">
          <ul>
            @for (item of data.bookletsInTestTakersValidation.missing; track item) {
              <li>
                <span>{{ item }}</span>
                <button mat-icon-button (click)="deleteBooklet(item)" [title]="'ws-admin.delete-booklet' | translate">
                  <mat-icon>delete</mat-icon>
                </button>
              </li>
            }
          </ul>
        </div>
      }
      @if (data.bookletsInTestTakersValidation.complete) {
        <p class="status-row">
          @if (data.bookletsInTestTakersValidation.complete) {
            <span class="status-complete">
                  <mat-icon class="status-icon">check_circle</mat-icon>
                </span>
          }
        </p>
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-booklets-in-testtakers-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (data && data.referencedBookletsExistValidation) {
    <div class="validation-card global-booklet-testtakers-check-card" [class.complete]="data.referencedBookletsExistValidation.complete" [class.incomplete]="!data.referencedBookletsExistValidation.complete">
      @if (!data.referencedBookletsExistValidation.complete && data.referencedBookletsExistValidation.missing && data.referencedBookletsExistValidation.missing.length > 0) {
        <div class="missing-items">
          <p>
            <mat-icon class="missing-icon">warning_amber</mat-icon>
            {{ 'ws-admin.validation-referenced-booklets-missing' | translate }}:
          </p>
          <ul>
            @for (item of data.referencedBookletsExistValidation.missing; track item) {
              <li>{{ item }}</li>
            }
          </ul>
        </div>
      }
      @if (data.referencedBookletsExistValidation.complete) {
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-referenced-booklets-exist-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (data && data.testTakersDuplicatesValidation) {
    <div class="validation-card global-booklet-testtakers-check-card" [class.complete]="data.testTakersDuplicatesValidation.complete" [class.incomplete]="!data.testTakersDuplicatesValidation.complete">
      @if (!data.testTakersDuplicatesValidation.complete && data.testTakersDuplicatesValidation.missing && data.testTakersDuplicatesValidation.missing.length > 0) {
        <div class="missing-items">
          <p>
            <mat-icon class="missing-icon">warning_amber</mat-icon>
            {{ 'ws-admin.validation-testtakers-duplicates-found' | translate }}:
          </p>
          <ul>
            @for (item of data.testTakersDuplicatesValidation.missing; track item) {
              <li>{{ item }}</li>
            }
          </ul>
        </div>
      }
      @if (data.testTakersDuplicatesValidation.complete) {
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-testtakers-duplicates-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (data && data.testTakersToPersonValidation) {
    <div class="validation-card global-person-check-card" [class.complete]="data.testTakersToPersonValidation.complete" [class.incomplete]="!data.testTakersToPersonValidation.complete">
      <p class="status-row">
        Status:
        @if (data.testTakersToPersonValidation.complete) {
          <span class="status-complete">
            <mat-icon class="status-icon">check_circle</mat-icon>
            {{ 'ws-admin.validation-complete' | translate }}
          </span>
        }
        @if (!data.testTakersToPersonValidation.complete) {
          <span class="status-incomplete">
            <mat-icon class="status-icon">error</mat-icon>
            {{ 'ws-admin.validation-incomplete' | translate }}
          </span>
        }
      </p>
      @if (!data.testTakersToPersonValidation.complete && data.testTakersToPersonValidation.missing && data.testTakersToPersonValidation.missing.length > 0) {
        <div class="missing-items">
          <p>
            <mat-icon class="missing-icon">warning_amber</mat-icon>
            {{ 'ws-admin.validation-testtakers-to-person-missing' | translate }}:
          </p>
          <ul>
            @for (item of data.testTakersToPersonValidation.missing; track item) {
              <li>{{ item }}</li>
            }
          </ul>
        </div>
      }
      @if (data.testTakersToPersonValidation.complete) {
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-testtakers-to-person-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (data && data.ignoredTestTakersFiles && data.ignoredTestTakersFiles.length > 0) {
    <div class="validation-card ignored-testtakers-card">
      <h4>
        <mat-icon class="section-icon">info_outline</mat-icon>
        {{ 'ws-admin.validation-ignored-testtakers-files' | translate }}
      </h4>
      <div class="missing-items">
        <p>
          <mat-icon class="missing-icon">info</mat-icon>
          {{ 'ws-admin.validation-ignored-testtakers-files-message' | translate }}:
        </p>
        <ul>
          @for (item of data.ignoredTestTakersFiles; track item) {
            <li>{{ item }}</li>
          }
        </ul>
      </div>
    </div>
  }

  @if (data && data.allUnitsHavePlayerValidation) {
    <div class="validation-card global-player-check-card" [class.complete]="data.allUnitsHavePlayerValidation.complete" [class.incomplete]="!data.allUnitsHavePlayerValidation.complete">
      @if (!data.allUnitsHavePlayerValidation.complete && data.allUnitsHavePlayerValidation.missing && data.allUnitsHavePlayerValidation.missing.length > 0) {
        <div class="missing-items">
          <p>
            <mat-icon class="missing-icon">warning_amber</mat-icon>
            {{ 'ws-admin.validation-units-missing-player' | translate }}:
          </p>
          <ul>
            @for (item of data.allUnitsHavePlayerValidation.missing; track item) {
              <li>{{ item }}</li>
            }
          </ul>
        </div>
      }
      @if (data.allUnitsHavePlayerValidation.complete) {
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-all-units-have-player-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (data && data.orphanedUnitsValidation) {
    <div class="validation-card orphaned-units-card" [class.complete]="data.orphanedUnitsValidation.complete" [class.incomplete]="!data.orphanedUnitsValidation.complete">
      @if (!data.orphanedUnitsValidation.complete && data.orphanedUnitsValidation.missing && data.orphanedUnitsValidation.missing.length > 0) {
        <div class="missing-items">
          <p>
            <mat-icon class="missing-icon">info</mat-icon> <!-- Changed icon for informational message -->
            {{ 'ws-admin.validation-orphaned-units-message' | translate }}:
          </p>
          <ul>
            @for (item of data.orphanedUnitsValidation.missing; track item) {
              <li>{{ item }}</li>
            }
          </ul>
        </div>
      }
      @if (data.orphanedUnitsValidation.complete) {
        <div class="all-clear-message">
          <p>
            <mat-icon class="status-icon">check_circle_outline</mat-icon>
            {{ 'ws-admin.validation-orphaned-units-clear' | translate }}
          </p>
        </div>
      }
    </div>
  }

  @if (bookletValidationResults && bookletValidationResults.length > 0) {
    <div class="scroll-container">
      @for (bookletResult of bookletValidationResults; track bookletResult) {
        <div class="booklet-validation-container">
          <h3 class="booklet-header">
            <mat-icon class="booklet-icon">library_books</mat-icon>
            Booklet: {{ bookletResult.bookletId }}
          </h3>
          <div class="validation-card" [class.complete]="bookletResult.validationDetails.bookletSelfStatus.complete" [class.incomplete]="!bookletResult.validationDetails.bookletSelfStatus.complete">
            <h4>
              <mat-icon class="section-icon">book</mat-icon>
              {{ getSectionDisplayName('bookletSelfStatus') }}
            </h4>
            <p class="status-row">
              Status:
              @if (bookletResult.validationDetails.bookletSelfStatus.complete) {
                <span class="status-complete">
                  <mat-icon class="status-icon">check_circle</mat-icon>
                  Vollständig
                </span>
              }
              @if (!bookletResult.validationDetails.bookletSelfStatus.complete) {
                <span class="status-incomplete">
                  <mat-icon class="status-icon">error</mat-icon>
                  Unvollständig
                </span>
              }
            </p>
            <!-- No missing items list for bookletSelfStatus as it's a single file check -->
            <div class="files-list-container">
              <!-- No toggle for bookletSelfStatus files, directly show -->
              <p class="files-header">
                <mat-icon class="files-icon">list</mat-icon>
                <span>Datei:</span>
              </p>
              <div class="files-list expanded"> <!-- Always expanded for the single booklet file -->
                <ul>
                  @for (file of bookletResult.validationDetails.bookletSelfStatus.files; track file) {
                    <li [ngClass]="{'file-exists': file.exists, 'file-missing': !file.exists}">
                      <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                      {{ file.filename }}
                    </li>
                  }
                </ul>
              </div>
            </div>
          </div>
          <!-- Iterate over other sections (units, schemes, etc.) within this booklet -->
          @for (sectionKey of getDataValidationSectionKeys(bookletResult.validationDetails); track sectionKey) {
            <div class="validation-card" [class.complete]="bookletResult.validationDetails[sectionKey]?.complete" [class.incomplete]="!bookletResult.validationDetails[sectionKey]?.complete">
              <h4> <!-- Changed from h3 to h4 for section title -->
                <mat-icon class="section-icon">{{ sectionKey === 'units' ? 'view_module' : sectionKey === 'schemes' ? 'schema' : sectionKey === 'definitions' ? 'description' : 'play_circle' }}</mat-icon>
                {{ getSectionDisplayName(sectionKey.toString()) }}
              </h4>
              <p class="status-row">
                Status:
                @if (bookletResult.validationDetails[sectionKey]?.complete) {
                  <span class="status-complete">
                    <mat-icon class="status-icon">check_circle</mat-icon>
                    Vollständig
                  </span>
                }
                @if (!bookletResult.validationDetails[sectionKey]?.complete) {
                  <span class="status-incomplete">
                    <mat-icon class="status-icon">error</mat-icon>
                    Unvollständig
                  </span>
                }
              </p>
              @if (!bookletResult.validationDetails[sectionKey]?.complete && bookletResult.validationDetails[sectionKey]?.missing.length > 0) {
                <div class="missing-items">
                  <p>
                    <mat-icon class="missing-icon">warning</mat-icon>
                    Fehlende Dateien:
                  </p>
                  <ul>
                    @for (item of bookletResult.validationDetails[sectionKey]?.missing; track item) {
                      <li>{{ item }}</li>
                    }
                  </ul>
                </div>
              }
              <div class="files-list-container">
                <p class="files-header" (click)="toggleFilesList(bookletResult.bookletId, sectionKey)">
                  <mat-icon class="files-icon">list</mat-icon>
                  <span>Alle Dateien:</span>
                  <mat-icon class="toggle-icon">{{ isFilesListExpanded(bookletResult.bookletId, sectionKey) ? 'expand_less' : 'expand_more' }}</mat-icon>
                </p>
                <div class="files-list" [ngClass]="{'expanded': isFilesListExpanded(bookletResult.bookletId, sectionKey) }">
                  <ul>
                    @for (file of bookletResult.validationDetails[sectionKey]?.files; track file) {
                      <li [ngClass]="{'file-exists': file.exists, 'file-missing': !file.exists}">
                        <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                        {{ file.filename }}
                      </li>
                    }
                  </ul>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
  @if ((!bookletValidationResults || bookletValidationResults.length === 0) && !data.orphanedUnitsValidation && !data.allUnitsHavePlayerValidation && !data.bookletsInTestTakersValidation && !data.referencedBookletsExistValidation && !data.testTakersDuplicatesValidation && (!data.ignoredTestTakersFiles || data.ignoredTestTakersFiles.length === 0) && !data.testTakersToPersonValidation) {
    <div class="no-results">
      <p>{{ 'ws-admin.validation-no-data' | translate }}</p>
    </div>
  }
  @if (bookletValidationResults && bookletValidationResults.length === 0 && data.orphanedUnitsValidation && data.orphanedUnitsValidation.complete && data.allUnitsHavePlayerValidation && data.allUnitsHavePlayerValidation.complete && data.bookletsInTestTakersValidation && data.bookletsInTestTakersValidation.complete && data.referencedBookletsExistValidation && data.referencedBookletsExistValidation.complete && data.testTakersDuplicatesValidation && data.testTakersDuplicatesValidation.complete && data.testTakersToPersonValidation && data.testTakersToPersonValidation.complete) {
    <div class="no-booklets-but-orphaned-clear">
      <!-- This case might be redundant if orphanedUnitsValidation section already shows a clear message -->
      <p>{{ 'ws-admin.validation-no-booklets-to-display' | translate }}</p>
    </div>
  }
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-raised-button
    color="primary"
    type="submit"
    [mat-dialog-close]="true">
    {{ 'close' | translate }}
  </button>
</mat-dialog-actions>
