<mat-dialog-content>
    <div class="scroll-container">
      @if (duplicateTestTakers && duplicateTestTakers.length > 0) {
        <div class="missing-units-warning duplicate-testtakers-warning">
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon class="warning-icon">error</mat-icon>
                <span class="warning-title">Doppelte TestTaker gefunden</span>
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="warning-content">
              <p>Die folgenden Login-Namen wurden in mehreren TestTaker-Dateien gefunden. Bitte wählen Sie aus, welche Vorkommen Sie behalten möchten.</p>

              @for (duplicate of duplicateTestTakers; track duplicate.login) {
                <div class="duplicate-item">
                  <p class="duplicate-login">Login: <strong>{{ duplicate.login }}</strong></p>
                  <div class="duplicate-occurrences">
                    @for (occurrence of duplicate.occurrences; track occurrence.testTaker) {
                      <div class="occurrence-item">
                        <mat-checkbox
                          [checked]="getSelectedOccurrence(duplicate.login) === occurrence.testTaker"
                          (change)="selectDuplicateOccurrence(duplicate.login, occurrence.testTaker)">
                          <strong>{{ occurrence.testTaker }}</strong> ({{ occurrence.mode }})
                        </mat-checkbox>
                      </div>
                    }
                  </div>
                </div>
              }

              <div class="resolve-button-container">
                <button
                  mat-raised-button
                  color="primary"
                  class="resolve-button"
                  (click)="resolveDuplicateTestTakers()"
                  [disabled]="isResolvingDuplicates">
                  <mat-icon>{{ isResolvingDuplicates ? 'hourglass_empty' : 'check_circle' }}</mat-icon>
                  @if (isResolvingDuplicates) {
                    Wird bearbeitet...
                  } @else {
                    Doppelte TestTaker auflösen
                  }
                </button>
              </div>
            </div>
          </mat-expansion-panel>
        </div>
      }

      @if (filteredTestTakers && filteredTestTakers.length > 0) {
        <div class="missing-units-warning filtered-testtakers-warning">
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon class="warning-icon">warning</mat-icon>
                <span class="warning-title">TestTaker zum Filtern</span>
              </mat-panel-title>
              <mat-panel-description>
                {{ selection.selected.length }} / {{ filteredTestTakers.length }}
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="warning-content">
              <div class="mode-selection">
                <div class="select-all-row">
                  <mat-checkbox
                    [checked]="allSelected"
                    [indeterminate]="selection.hasValue() && !allSelected"
                    (change)="toggleAllSelection()">
                    Alle auswählen
                  </mat-checkbox>
                  <span class="count-badge">{{ selection.selected.length }} / {{ filteredTestTakers.length }}</span>
                </div>

                @for (modeGroup of modeGroups; track modeGroup) {
                  <div class="mode-group">
                    <mat-checkbox
                      [checked]="isModeSelected(modeGroup.mode)"
                      (change)="toggleModeSelection(modeGroup.mode)">
                      {{ modeGroup.mode }} ({{ modeGroup.count }})
                    </mat-checkbox>
                  </div>
                }
              </div>

              <cdk-virtual-scroll-viewport class="test-takers-list" [itemSize]="48" [minBufferPx]="200" [maxBufferPx]="400">
                <div *cdkVirtualFor="let item of filteredTestTakers; trackBy: trackByFn" class="virtual-item">
                  <mat-checkbox
                    [checked]="selection.isSelected(item)"
                    (change)="toggleSelection(item)">
                    <strong>{{ item.testTaker }}:</strong> {{ item.login }} ({{ item.mode }})
                  </mat-checkbox>
                </div>
              </cdk-virtual-scroll-viewport>

              <div class="exclude-button-container">
                <button
                  mat-raised-button
                  color="warn"
                  class="exclude-button"
                  (click)="markTestTakersAsExcluded()"
                  [disabled]="isExcluding || selection.selected.length === 0">
                  <mat-icon>{{ isExcluding ? 'hourglass_empty' : 'block' }}</mat-icon>
                  @if (isExcluding) {
                    Wird bearbeitet... ({{ excludingProgress }}%)
                  } @else {
                    Ausgewählte TestTaker ausschließen ({{ selection.selected.length }})
                  }
                </button>

                @if (isExcluding) {
                  <div class="progress-container">
                    <div class="progress-bar" [style.width.%]="excludingProgress"></div>
                  </div>
                }
              </div>
            </div>
          </mat-expansion-panel>
        </div>
      }
      @if (data.validationResults && data.validationResults.length > 0) {
        <mat-tab-group>
          @for (val of data.validationResults; track val.testTaker) {
            <mat-tab [label]="val.testTaker">
              <h4>
                <mat-icon class="test-taker-icon">person</mat-icon>
                {{val.testTaker}}
                <button
                  mat-icon-button
                  class="test-taker-xml-button"
                  (click)="showTestTakerXml(val.testTaker)"
                  matTooltip="TestTaker XML anzeigen"
                  [attr.aria-label]="'TestTaker XML anzeigen'">
                  <mat-icon>code</mat-icon>
                </button>
              </h4>

              @if (val.booklets.missing && val.booklets.missing.length > 0) {
                <div class="missing-units-warning">
                  <mat-icon class="warning-icon">warning</mat-icon>
                  <div class="warning-content">
                    <p class="warning-title">Fehlende Testhefte:</p>
                    <ul>
                      @for (booklet of val.booklets.missing; track booklet) {
                        <li>{{ booklet }}</li>
                      }
                    </ul>
                  </div>
                </div>
              }

              <div class="validation-container">
                <!-- Booklets Section -->
                <div class="validation-card">
                  <h3>
                    <mat-icon class="section-icon">book</mat-icon>
                    Testhefte
                  </h3>
                  <p class="status-row">
                    Status:
                    @if (val.booklets.complete) {
                      <span class="status-complete">
                        <mat-icon class="status-icon">check_circle</mat-icon>
                        Vollständig
                      </span>
                    }
                    @if (!val.booklets.complete) {
                      <span class="status-incomplete">
                        <mat-icon class="status-icon">error</mat-icon>
                        @if (val.booklets.missing && val.booklets.missing.length > 0) {
                          Unvollständig (Testhefte fehlen)
                        } @else {
                          Unvollständig
                        }
                      </span>
                    }
                  </p>
                  <div class="files-list-container">
                    <p class="files-header" (click)="toggleFilesList(val.testTaker, 'booklets')">
                      <mat-icon class="files-icon">list</mat-icon>
                      <span>
                        Alle Dateien: {{ val.booklets.files.length }}
                        (vorhanden: {{ getExistingCount(val.booklets) }},
                        fehlend: {{ getMissingCount(val.booklets) }})
                      </span>
                      <mat-icon class="toggle-icon">{{ isFilesListExpanded(val.testTaker, 'booklets') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </p>
                    <div class="files-list" [class.expanded]="isFilesListExpanded(val.testTaker, 'booklets')">
                      <ul>
                        @for (file of val.booklets.files; track file) {
                          <li [class.file-exists]="file.exists" [class.file-missing]="!file.exists">
                            <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                            <span class="file-name">{{ file.filename }}</span>
                            @if (file.schemaValid === false) {
                              <mat-icon
                                class="file-status-icon"
                                matTooltip="{{ (file.schemaErrors || []).join('\n') }}">
                                report_problem
                              </mat-icon>
                            }
                            <button
                              mat-icon-button
                              class="file-action-button"
                              (click)="openBookletInfo(file.filename)"
                              matTooltip="Testheft anzeigen"
                              [attr.aria-label]="'Testheft anzeigen'">
                              <mat-icon>info</mat-icon>
                            </button>
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
                <!-- Units Section -->
                <div class="validation-card">
                  <h3>
                    <mat-icon class="section-icon">view_module</mat-icon>
                    Aufgaben
                  </h3>
                  <p class="status-row">
                    Status:
                    @if (val.units.complete) {
                      <span class="status-complete">
                        <mat-icon class="status-icon">check_circle</mat-icon>
                        Vollständig
                      </span>
                    }
                    @if (!val.units.complete) {
                      <span class="status-incomplete"
                            [matTooltip]="val.units.missing && val.units.missing.length === 0 && !val.booklets.complete ? 'Nicht überprüfbar: Testhefte fehlen oder sind unvollständig' : ''">
                        <mat-icon class="status-icon">error</mat-icon>
                        @if (val.units.missing && val.units.missing.length > 0) {
                          Unvollständig (Aufgaben fehlen)
                        } @else if (!val.booklets.complete) {
                          Nicht überprüfbar (Voraussetzungen fehlen)
                        } @else {
                          Unvollständig
                        }
                      </span>
                    }
                  </p>
                  <div class="files-list-container">
                    <p class="files-header" (click)="toggleFilesList(val.testTaker, 'units')">
                      <mat-icon class="files-icon">list</mat-icon>
                      <span>
                        Alle Dateien: {{ val.units.files.length }}
                        (vorhanden: {{ getExistingCount(val.units) }},
                        fehlend: {{ getMissingCount(val.units) }})
                      </span>
                      <mat-icon class="toggle-icon">{{ isFilesListExpanded(val.testTaker, 'units') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </p>
                    <div class="files-list" [class.expanded]="isFilesListExpanded(val.testTaker, 'units')">
                      <ul>
                        @for (file of val.units.files; track file) {
                          <li [class.file-exists]="file.exists" [class.file-missing]="!file.exists">
                            <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                            <span class="file-name">{{ file.filename }}</span>
                            @if (file.schemaValid === false) {
                              <mat-icon
                                class="file-status-icon"
                                matTooltip="{{ (file.schemaErrors || []).join('\n') }}">
                                report_problem
                              </mat-icon>
                            }
                            <button
                              mat-icon-button
                              class="file-action-button"
                              (click)="openUnitInfo(file.filename)"
                              matTooltip="Aufgabe anzeigen"
                              [attr.aria-label]="'Aufgabe anzeigen'">
                              <mat-icon>info</mat-icon>
                            </button>
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
                <!-- Schemes Section -->
                <div class="validation-card">
                  <h3>
                    <mat-icon class="section-icon">schema</mat-icon>
                    Kodierschemata
                  </h3>
                  <p class="status-row">
                    Status:
                    @if (val.schemes.complete) {
                      <span class="status-complete">
                        <mat-icon class="status-icon">check_circle</mat-icon>
                        Vollständig
                      </span>
                    }
                    @if (!val.schemes.complete) {
                      <span class="status-incomplete"
                            [matTooltip]="val.schemes.missing && val.schemes.missing.length === 0 && !val.units.complete ? 'Nicht überprüfbar: Aufgaben fehlen oder sind unvollständig' : ''">
                        <mat-icon class="status-icon">error</mat-icon>
                        @if (val.schemes.missing && val.schemes.missing.length > 0) {
                          Unvollständig (Kodierschemata fehlen)
                        } @else if (!val.units.complete) {
                          Nicht überprüfbar (Voraussetzungen fehlen)
                        } @else {
                          Unvollständig
                        }
                      </span>
                    }
                  </p>
                  <div class="files-list-container">
                    <p class="files-header" (click)="toggleFilesList(val.testTaker, 'schemes')">
                      <mat-icon class="files-icon">list</mat-icon>
                      <span>
                        Alle Dateien: {{ val.schemes.files.length }}
                        (vorhanden: {{ getExistingCount(val.schemes) }},
                        fehlend: {{ getMissingCount(val.schemes) }})
                      </span>
                      <mat-icon class="toggle-icon">{{ isFilesListExpanded(val.testTaker, 'schemes') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </p>
                    <div class="files-list" [class.expanded]="isFilesListExpanded(val.testTaker, 'schemes')">
                      <ul>
                        @for (file of val.schemes.files; track file) {
                          <li [class.file-exists]="file.exists" [class.file-missing]="!file.exists">
                            <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                            <span class="file-name">{{ file.filename }}</span>
                            @if (file.schemaValid === false) {
                              <mat-icon
                                class="file-status-icon"
                                matTooltip="{{ (file.schemaErrors || []).join('\n') }}">
                                report_problem
                              </mat-icon>
                            }
                            <button
                              mat-icon-button
                              class="file-action-button"
                              (click)="openSchemeFile(file.filename)"
                              matTooltip="Kodierschema anzeigen"
                              [attr.aria-label]="'Kodierschema anzeigen'">
                              <mat-icon>schema</mat-icon>
                            </button>
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
                <!-- Definitions Section -->
                <div class="validation-card">
                  <h3>
                    <mat-icon class="section-icon">description</mat-icon>
                    Aufgabendefinitionen
                  </h3>
                  <p class="status-row">
                    Status:
                    @if (val.definitions.complete) {
                      <span class="status-complete">
                        <mat-icon class="status-icon">check_circle</mat-icon>
                        Vollständig
                      </span>
                    }
                    @if (!val.definitions.complete) {
                      <span class="status-incomplete"
                            [matTooltip]="val.definitions.missing && val.definitions.missing.length === 0 && !val.units.complete ? 'Nicht überprüfbar: Aufgaben fehlen oder sind unvollständig' : ''">
                        <mat-icon class="status-icon">error</mat-icon>
                        @if (val.definitions.missing && val.definitions.missing.length > 0) {
                          Unvollständig (Definitionen fehlen)
                        } @else if (!val.units.complete) {
                          Nicht überprüfbar (Voraussetzungen fehlen)
                        } @else {
                          Unvollständig
                        }
                      </span>
                    }
                  </p>
                  <div class="files-list-container">
                    <p class="files-header" (click)="toggleFilesList(val.testTaker, 'definitions')">
                      <mat-icon class="files-icon">list</mat-icon>
                      <span>
                        Alle Dateien: {{ val.definitions.files.length }}
                        (vorhanden: {{ getExistingCount(val.definitions) }},
                        fehlend: {{ getMissingCount(val.definitions) }})
                      </span>
                      <mat-icon class="toggle-icon">{{ isFilesListExpanded(val.testTaker, 'definitions') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </p>
                    <div class="files-list" [class.expanded]="isFilesListExpanded(val.testTaker, 'definitions')">
                      <ul>
                        @for (file of val.definitions.files; track file) {
                          <li [class.file-exists]="file.exists" [class.file-missing]="!file.exists">
                            <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                            <span class="file-name">{{ file.filename }}</span>
                            @if (file.schemaValid === false) {
                              <mat-icon
                                class="file-status-icon"
                                matTooltip="{{ (file.schemaErrors || []).join('\n') }}">
                                report_problem
                              </mat-icon>
                            }
                            <button
                              mat-icon-button
                              class="file-action-button"
                              (click)="openDefinitionFile(file.filename)"
                              matTooltip="Aufgabendefinition anzeigen"
                              [attr.aria-label]="'Aufgabendefinition anzeigen'">
                              <mat-icon>description</mat-icon>
                            </button>
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
                <!-- Player Section -->
                <div class="validation-card">
                  <h3>
                    <mat-icon class="section-icon">play_circle</mat-icon>
                    Player
                  </h3>
                  <p class="status-row">
                    Status:
                    @if (val.player.complete) {
                      <span class="status-complete">
                        <mat-icon class="status-icon">check_circle</mat-icon>
                        Vollständig
                      </span>
                    }
                    @if (!val.player.complete) {
                      <span class="status-incomplete"
                            [matTooltip]="val.player.missing && val.player.missing.length === 0 && !val.units.complete ? 'Nicht überprüfbar: Aufgaben fehlen oder sind unvollständig' : ''">
                        <mat-icon class="status-icon">error</mat-icon>
                        @if (val.player.missing && val.player.missing.length > 0) {
                          Unvollständig (Player fehlen)
                        } @else if (!val.units.complete) {
                          Nicht überprüfbar (Voraussetzungen fehlen)
                        } @else {
                          Unvollständig
                        }
                      </span>
                    }
                  </p>
                  <div class="files-list-container">
                    <p class="files-header" (click)="toggleFilesList(val.testTaker, 'player')">
                      <mat-icon class="files-icon">list</mat-icon>
                      <span>
                        Alle Dateien: {{ val.player.files.length }}
                        (vorhanden: {{ getExistingCount(val.player) }},
                        fehlend: {{ getMissingCount(val.player) }})
                      </span>
                      <mat-icon class="toggle-icon">{{ isFilesListExpanded(val.testTaker, 'player') ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </p>
                    <div class="files-list" [class.expanded]="isFilesListExpanded(val.testTaker, 'player')">
                      <ul>
                        @for (file of val.player.files; track file) {
                          <li [class.file-exists]="file.exists" [class.file-missing]="!file.exists">
                            <mat-icon class="file-status-icon">{{ file.exists ? 'check_circle' : 'error' }}</mat-icon>
                            <span class="file-name">{{ file.filename }}</span>
                            @if (file.schemaValid === false) {
                              <mat-icon
                                class="file-status-icon"
                                matTooltip="{{ (file.schemaErrors || []).join('\n') }}">
                                report_problem
                              </mat-icon>
                            }
                          </li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </mat-tab>
          }
        </mat-tab-group>
      }
    </div>
  </mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-raised-button
    color="primary"
    type="submit"
    [mat-dialog-close]="true">
    {{ 'close' | translate }}
  </button>
</mat-dialog-actions>

