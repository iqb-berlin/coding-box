<h1 mat-dialog-title>Antworten validieren</h1>
<mat-dialog-content>
  <mat-stepper orientation="vertical" [linear]="true" #stepper>
    <mat-step label="Testperson definiert" >
      <p>Prüft, ob für jede Testperson in der Datenbank ein entsprechender Eintrag in den TestTakers XML-Dateien existiert.</p>
      <button mat-button (click)="validateTestTakers()">TestTakers validieren</button>
      @if (isTestTakersValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">TestTakers werden validiert...</p>
        </div>
      }
      @if (testTakersValidationResult) {
        <div>
          <p>
            @if (testTakersValidationResult.testTakersFound) {
              TestTakers gefunden: {{ testTakersValidationResult.totalGroups }} Gruppen, {{ testTakersValidationResult.totalLogins }} Logins, {{ testTakersValidationResult.totalBookletCodes }} Booklet-Codes.
            } @else {
              Keine TestTakers gefunden.
            }
          </p>
          @if (testTakersValidationResult.missingPersons.length > 0) {
            <p>
              {{ testTakersValidationResult.missingPersons.length }} Testpersonen wurden nicht in den TestTakers XML-Dateien gefunden.
            </p>
            <div class="actions-container">
              <button mat-button (click)="toggleMissingPersonsExpansion()">
                {{ expandedMissingPersonsPanel ? 'Liste einklappen' : 'Liste ausklappen' }}
              </button>
            </div>

            <mat-expansion-panel [expanded]="expandedMissingPersonsPanel">
              <table mat-table [dataSource]="paginatedMissingPersons">
                <ng-container matColumnDef="group">
                  <th mat-header-cell *matHeaderCellDef>Gruppe</th>
                  <td mat-cell *matCellDef="let element">{{ element.group }}</td>
                </ng-container>
                <ng-container matColumnDef="login">
                  <th mat-header-cell *matHeaderCellDef>Login</th>
                  <td mat-cell *matCellDef="let element">{{ element.login }}</td>
                </ng-container>
                <ng-container matColumnDef="code">
                  <th mat-header-cell *matHeaderCellDef>Code</th>
                  <td mat-cell *matCellDef="let element">{{ element.code }}</td>
                </ng-container>
                <ng-container matColumnDef="reason">
                  <th mat-header-cell *matHeaderCellDef>Grund</th>
                  <td mat-cell *matCellDef="let element">{{ element.reason }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['group', 'login', 'code', 'reason']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['group', 'login', 'code', 'reason'];"></tr>
              </table>
            </mat-expansion-panel>
          } @else {
            <p>Alle Testpersonen wurden in den TestTakers XML-Dateien gefunden.</p>
          }
        </div>
      }
      <div>
        <button mat-button matStepperNext>Weiter</button>
      </div>
    </mat-step>
    <mat-step label="Variable definiert">
      <p>Prüft, ob die Variable in der Unit.xml definiert ist.</p>
      <button mat-button (click)="validateVariables()">Variablen validieren</button>
      @if (isVariableValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Variablen werden validiert...</p>
        </div>
      }
      @if (invalidVariables.length > 0 || totalInvalidVariables > 0) {
        <p>
          {{ totalInvalidVariables }} ungültige Variablen gefunden.
        </p>
        @if (invalidVariables.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleExpansion()">
              {{ expandedPanel ? 'Liste einklappen' : 'Liste ausklappen' }}
            </button>
            <button mat-button (click)="selectAllResponses()">Alle auswählen</button>
            <button mat-button (click)="deselectAllResponses()">Auswahl aufheben</button>
            <button mat-button color="warn" (click)="deleteSelectedResponses()" [disabled]="isDeletingResponses || selectedResponses.size === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Ausgewählte löschen ({{ selectedResponses.size }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedPanel">
            <table mat-table [dataSource]="paginatedVariables">
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>Auswählen</th>
                <td mat-cell *matCellDef="let element">
                  <input type="checkbox"
                         [checked]="isResponseSelected(element.responseId)"
                         (change)="toggleResponseSelection(element.responseId)"
                         [disabled]="!element.responseId">
                </td>
              </ng-container>
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>Dateiname</th>
                <td mat-cell *matCellDef="let element">
                  <a href="javascript:void(0)" (click)="showUnitXml(element.fileName)">{{ element.fileName }}</a>
                </td>
              </ng-container>
              <ng-container matColumnDef="variableId">
                <th mat-header-cell *matHeaderCellDef>Variablen-ID</th>
                <td mat-cell *matCellDef="let element">{{ element.variableId }}</td>
              </ng-container>
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Wert</th>
                <td mat-cell *matCellDef="let element">{{ element.value }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['select', 'fileName', 'variableId', 'value']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['select', 'fileName', 'variableId', 'value'];"></tr>
            </table>
            <mat-paginator #variablePaginator
                         [pageSize]="variablePageSize"
                         [pageSizeOptions]="pageSizeOptions"
                         [length]="totalInvalidVariables"
                         [pageIndex]="currentVariablePage - 1"
                         (page)="onVariablePageChange($event)"
                         aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      }
      <div>
        <button mat-button matStepperNext>Weiter</button>
      </div>
    </mat-step>
    <mat-step label="Variable ist gültig">
      <p>Prüft, ob der Wert der Variable dem definierten Typ entspricht (string, integer, number, boolean, json).</p>
      <button mat-button (click)="validateVariableTypes()">Variablentypen validieren</button>
      @if (isVariableTypeValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Variablentypen werden validiert...</p>
        </div>
      }
      @if (invalidTypeVariables.length > 0 || totalInvalidTypeVariables > 0) {
        <p>
          {{ totalInvalidTypeVariables }} ungültige Variablenwerte gefunden.
        </p>
        @if (invalidTypeVariables.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleTypeExpansion()">
              {{ expandedTypePanel ? 'Liste einklappen' : 'Liste ausklappen' }}
            </button>
            <button mat-button (click)="selectAllTypeResponses()">Alle auswählen</button>
            <button mat-button (click)="deselectAllTypeResponses()">Auswahl aufheben</button>
            <button mat-button color="warn" (click)="deleteSelectedTypeResponses()" [disabled]="isDeletingResponses || selectedTypeResponses.size === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Ausgewählte löschen ({{ selectedTypeResponses.size }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedTypePanel">
            <table mat-table [dataSource]="paginatedTypeVariables">
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>Auswählen</th>
                <td mat-cell *matCellDef="let element">
                  <input type="checkbox"
                         [checked]="isTypeResponseSelected(element.responseId)"
                         (change)="toggleTypeResponseSelection(element.responseId)"
                         [disabled]="!element.responseId">
                </td>
              </ng-container>
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>Dateiname</th>
                <td mat-cell *matCellDef="let element">
                  <a href="javascript:void(0)" (click)="showUnitXml(element.fileName)">{{ element.fileName }}</a>
                </td>
              </ng-container>
              <ng-container matColumnDef="variableId">
                <th mat-header-cell *matHeaderCellDef>Variablen-ID</th>
                <td mat-cell *matCellDef="let element">{{ element.variableId }}</td>
              </ng-container>
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Wert</th>
                <td mat-cell *matCellDef="let element">{{ element.value }}</td>
              </ng-container>
              <ng-container matColumnDef="expectedType">
                <th mat-header-cell *matHeaderCellDef>Erwarteter Typ</th>
                <td mat-cell *matCellDef="let element">{{ element.expectedType }}</td>
              </ng-container>
              <ng-container matColumnDef="errorReason">
                <th mat-header-cell *matHeaderCellDef>Fehlergrund</th>
                <td mat-cell *matCellDef="let element">{{ element.errorReason }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['select', 'fileName', 'variableId', 'value', 'expectedType', 'errorReason']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['select', 'fileName', 'variableId', 'value', 'expectedType', 'errorReason'];"></tr>
            </table>
            <mat-paginator #variableTypePaginator
                         [pageSize]="typeVariablePageSize"
                         [pageSizeOptions]="pageSizeOptions"
                         [length]="totalInvalidTypeVariables"
                         [pageIndex]="currentTypeVariablePage - 1"
                         (page)="onTypeVariablePageChange($event)"
                         aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      }
      <div>
        <button mat-button matStepperNext>Weiter</button>
      </div>
    </mat-step>
    <mat-step label="Status ist gültig">
      <p>Prüft, ob der Status der Antwort gültig ist (gemäß Unit.xml).</p>
      <button mat-button (click)="validateResponseStatus()">Antwortstatus validieren</button>
      @if (isResponseStatusValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Antwortstatus wird validiert...</p>
        </div>
      }
      @if (invalidStatusVariables.length > 0 || totalInvalidStatusVariables > 0) {
        <p>
          {{ totalInvalidStatusVariables }} ungültige Antwortstatus gefunden.
        </p>
        @if (invalidStatusVariables.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleStatusExpansion()">
              {{ expandedStatusPanel ? 'Liste einklappen' : 'Liste ausklappen' }}
            </button>
            <button mat-button (click)="selectAllStatusResponses()">Alle auswählen</button>
            <button mat-button (click)="deselectAllStatusResponses()">Auswahl aufheben</button>
            <button mat-button color="warn" (click)="deleteSelectedStatusResponses()" [disabled]="isDeletingResponses || selectedStatusResponses.size === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Ausgewählte löschen ({{ selectedStatusResponses.size }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedStatusPanel">
            <table mat-table [dataSource]="paginatedStatusVariables">
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>Auswählen</th>
                <td mat-cell *matCellDef="let element">
                  <input type="checkbox"
                         [checked]="isStatusResponseSelected(element.responseId)"
                         (change)="toggleStatusResponseSelection(element.responseId)"
                         [disabled]="!element.responseId">
                </td>
              </ng-container>
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>Dateiname</th>
                <td mat-cell *matCellDef="let element">
                  <a href="javascript:void(0)" (click)="showUnitXml(element.fileName)">{{ element.fileName }}</a>
                </td>
              </ng-container>
              <ng-container matColumnDef="variableId">
                <th mat-header-cell *matHeaderCellDef>Variablen-ID</th>
                <td mat-cell *matCellDef="let element">{{ element.variableId }}</td>
              </ng-container>
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Wert</th>
                <td mat-cell *matCellDef="let element">{{ element.value }}</td>
              </ng-container>
              <ng-container matColumnDef="errorReason">
                <th mat-header-cell *matHeaderCellDef>Fehlergrund</th>
                <td mat-cell *matCellDef="let element">{{ element.errorReason }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['select', 'fileName', 'variableId', 'value', 'errorReason']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['select', 'fileName', 'variableId', 'value', 'errorReason'];"></tr>
            </table>
            <mat-paginator #statusVariablePaginator
                         [pageSize]="statusVariablePageSize"
                         [pageSizeOptions]="pageSizeOptions"
                         [length]="totalInvalidStatusVariables"
                         [pageIndex]="currentStatusVariablePage - 1"
                         (page)="onStatusVariablePageChange($event)"
                         aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      }
      <div>
        <button mat-button matStepperNext>Weiter</button>
      </div>
    </mat-step>
    <mat-step label="Antwort vorgesehen">
      <p>Prüft, ob die Antwort für die Kombination Testperson x Booklet x Unit vorgesehen ist.</p>
      <div>
        <button mat-button matStepperNext>Daten bereinigen</button>
        <button mat-button matStepperNext>Daten behalten</button>
      </div>
    </mat-step>
    <mat-step label="Antworten für alle Gruppen">
      <p>Prüft, ob Antworten für alle Testperson-Gruppen vorliegen.</p>
      <div>
        <button mat-button matStepperNext>Daten bereinigen</button>
        <button mat-button matStepperNext>Daten behalten</button>
      </div>
    </mat-step>
  </mat-stepper>
</mat-dialog-content>
<mat-dialog-actions>
  <button mat-button (click)="closeWithResults()">Übernehmen</button>
  <button mat-button mat-dialog-close>Abbrechen</button>
</mat-dialog-actions>
