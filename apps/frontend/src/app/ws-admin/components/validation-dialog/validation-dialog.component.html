<h1 mat-dialog-title>Antwortdaten prüfen</h1>

<div class="validation-result"
     [ngClass]="{
       'validation-running': getOverallStatus() === 'running',
       'validation-error': getOverallStatus() === 'failed',
       'validation-success': getOverallStatus() === 'success',
       'validation-not-run': getOverallStatus() === 'not-run'
     }">
  <mat-icon *ngIf="getOverallStatus() === 'running'">hourglass_empty</mat-icon>
  <mat-icon *ngIf="getOverallStatus() === 'failed'">error</mat-icon>
  <mat-icon *ngIf="getOverallStatus() === 'success'">check_circle</mat-icon>
  <mat-icon *ngIf="getOverallStatus() === 'not-run'">radio_button_unchecked</mat-icon>
  <div style="display: flex; flex-direction: column; gap: 4px;">
    <div><strong>{{ getOverallHeadline() }}</strong></div>
    <div>{{ getOverallSubline() }}</div>
    <div style="opacity: 0.9;">{{ getRecommendedNextStep() }}</div>
  </div>
</div>

<div class="actions-container" style="margin-top: 8px;">
  <button mat-button color="primary" (click)="startAllValidations()" [disabled]="isAnyValidationRunning()">
    Alle Prüfungen starten
  </button>
</div>
<div class="info-banner" *ngIf="isAnyValidationRunning()">
  <mat-icon>info</mat-icon>
  <span>Validierungen laufen im Hintergrund weiter, auch wenn Sie diesen Dialog schließen.</span>
</div>

<mat-dialog-content>
  <mat-accordion multi="true">
    <mat-expansion-panel>
      <mat-expansion-panel-header
        class="validation-panel-header"
        [ngClass]="{
          'validation-running': getValidationStatus('testTakers') === 'running',
          'validation-error': getValidationStatus('testTakers') === 'failed',
          'validation-success': getValidationStatus('testTakers') === 'success',
          'validation-not-run': getValidationStatus('testTakers') === 'not-run'
        }">
        <mat-panel-title>
          <mat-icon *ngIf="getValidationStatus('testTakers') === 'running'">hourglass_empty</mat-icon>
          <mat-icon *ngIf="getValidationStatus('testTakers') === 'failed'">error</mat-icon>
          <mat-icon *ngIf="getValidationStatus('testTakers') === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="getValidationStatus('testTakers') === 'not-run'">radio_button_unchecked</mat-icon>
          <span style="margin-left: 8px;">{{ getValidationLabel('testTakers') }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (getValidationStatus('testTakers') === 'running') {
            <span class="validation-badge validation-running">Läuft…</span>
          } @else if (getValidationStatus('testTakers') === 'failed' && testTakersValidationResult) {
            <span class="validation-badge validation-error">{{ testTakersValidationResult.missingPersons.length }} fehlend</span>
          } @else if (getValidationStatus('testTakers') === 'success') {
            <span class="validation-badge validation-success">OK</span>
          } @else {
            <span class="validation-badge validation-not-run">Nicht ausgeführt</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="validation-details">
        <p class="validation-details-intro">Prüft, ob für jede Testperson in der Datenbank ein entsprechender Eintrag in den TestTakers XML-Dateien existiert.</p>

        <div class="validation-guidance">
          <div class="info-banner">
            <mat-icon>help</mat-icon>
            <span><strong>Warum ist das wichtig?</strong> {{ getValidationWhyText('testTakers') }}</span>
          </div>
          <div class="info-banner">
            <mat-icon>build</mat-icon>
            <span><strong>So beheben Sie es:</strong> {{ getValidationFixHint('testTakers') }}</span>
          </div>
        </div>

        <div class="validation-actions">
          <button mat-button (click)="validateTestTakers()" [disabled]="isAnyValidationRunning()">Testpersonen prüfen</button>
        </div>
      </div>

      @if (isTestTakersValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Testpersonen werden geprüft...</p>
        </div>
      }
      @if (testTakersValidationResult) {
        <div>
          @if (!testTakersValidationResult.testTakersFound) {
            <div class="validation-result validation-error">
              <mat-icon>error</mat-icon>
              <span>Prüfung fehlgeschlagen: Keine TestTakers gefunden.</span>
            </div>
          }
          @if (testTakersValidationResult.missingPersons.length > 0) {
            <div class="validation-result validation-error">
              <mat-icon>error</mat-icon>
              <span>Prüfung fehlgeschlagen: {{ testTakersValidationResult.missingPersons.length }} Testpersonen wurden nicht in den TestTakers XML-Dateien gefunden.</span>
            </div>
            <div class="actions-container">
              <button mat-button (click)="toggleMissingPersonsExpansion()">
                {{ expandedMissingPersonsPanel ? 'Details ausblenden' : 'Details anzeigen' }}
              </button>
            </div>

            <mat-expansion-panel [expanded]="expandedMissingPersonsPanel">
              <table mat-table [dataSource]="paginatedMissingPersons">
                <ng-container matColumnDef="group">
                  <th mat-header-cell *matHeaderCellDef>Gruppe</th>
                  <td mat-cell *matCellDef="let element">{{ element.group }}</td>
                </ng-container>
                <ng-container matColumnDef="login">
                  <th mat-header-cell *matHeaderCellDef>Login</th>
                  <td mat-cell *matCellDef="let element">{{ element.login }}</td>
                </ng-container>
                <ng-container matColumnDef="code">
                  <th mat-header-cell *matHeaderCellDef>Code</th>
                  <td mat-cell *matCellDef="let element">{{ element.code }}</td>
                </ng-container>
                <ng-container matColumnDef="reason">
                  <th mat-header-cell *matHeaderCellDef>Grund</th>
                  <td mat-cell *matCellDef="let element">{{ element.reason }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['group', 'login', 'code', 'reason']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['group', 'login', 'code', 'reason'];"></tr>
              </table>
            </mat-expansion-panel>
          } @else if (testTakersValidationWasRun) {
            <div class="validation-result validation-success">
              <mat-icon>check_circle</mat-icon>
              <span>Prüfung bestanden: Alle Testpersonen wurden in den TestTakers XML-Dateien gefunden.</span>
            </div>
          }
        </div>
      }
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header
        class="validation-panel-header"
        [ngClass]="{
          'validation-running': getValidationStatus('variables') === 'running',
          'validation-error': getValidationStatus('variables') === 'failed',
          'validation-success': getValidationStatus('variables') === 'success',
          'validation-not-run': getValidationStatus('variables') === 'not-run'
        }">
        <mat-panel-title>
          <mat-icon *ngIf="getValidationStatus('variables') === 'running'">hourglass_empty</mat-icon>
          <mat-icon *ngIf="getValidationStatus('variables') === 'failed'">error</mat-icon>
          <mat-icon *ngIf="getValidationStatus('variables') === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="getValidationStatus('variables') === 'not-run'">radio_button_unchecked</mat-icon>
          <span style="margin-left: 8px;">{{ getValidationLabel('variables') }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (getValidationStatus('variables') === 'running') {
            <span class="validation-badge validation-running">Läuft…</span>
          } @else if (getValidationStatus('variables') === 'failed') {
            <span class="validation-badge validation-error">{{ totalInvalidVariables }} ungültig</span>
          } @else if (getValidationStatus('variables') === 'success') {
            <span class="validation-badge validation-success">OK</span>
          } @else {
            <span class="validation-badge validation-not-run">Nicht ausgeführt</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="validation-details">
        <p class="validation-details-intro">Prüft, ob die Variable in der Unit.xml definiert ist.</p>

        <div class="validation-guidance">
          <div class="info-banner">
            <mat-icon>help</mat-icon>
            <span><strong>Warum ist das wichtig?</strong> {{ getValidationWhyText('variables') }}</span>
          </div>
          <div class="info-banner">
            <mat-icon>build</mat-icon>
            <span><strong>So beheben Sie es:</strong> {{ getValidationFixHint('variables') }}</span>
          </div>
        </div>

        <div class="validation-actions">
          <button mat-button (click)="validateVariables()" [disabled]="isAnyValidationRunning()">Variablen prüfen</button>
        </div>
      </div>

      @if (isVariableValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Variablen werden geprüft...</p>
        </div>
      }
      @if (invalidVariables.length > 0 || totalInvalidVariables > 0) {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>Prüfung fehlgeschlagen: {{ totalInvalidVariables }} ungültige Variablen gefunden.</span>
        </div>
        @if (invalidVariables.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleExpansion()">
              {{ expandedPanel ? 'Details ausblenden' : 'Details anzeigen' }}
            </button>
            <button mat-button (click)="selectAllResponses()">Alle auswählen</button>
            <button mat-button (click)="deselectAllResponses()">Auswahl aufheben</button>
            <button mat-button color="warn" (click)="deleteSelectedResponses()" [disabled]="isDeletingResponses || selectedResponses.size === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Ausgewählte löschen ({{ selectedResponses.size }})
              }
            </button>
            <button mat-button color="warn" (click)="deleteAllResponses()" [disabled]="isDeletingResponses || invalidVariables.length === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Alle löschen ({{ totalInvalidVariables }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedPanel">
            <table mat-table [dataSource]="paginatedVariables">
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>Auswählen</th>
                <td mat-cell *matCellDef="let element">
                  <input type="checkbox"
                         [checked]="isResponseSelected(element.responseId)"
                         (change)="toggleResponseSelection(element.responseId)"
                         [disabled]="!element.responseId">
                </td>
              </ng-container>
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>Dateiname</th>
                <td mat-cell *matCellDef="let element">
                  <a href="javascript:void(0)" (click)="showUnitXml(element.fileName)">{{ element.fileName }}</a>
                </td>
              </ng-container>
              <ng-container matColumnDef="variableId">
                <th mat-header-cell *matHeaderCellDef>Variablen-ID</th>
                <td mat-cell *matCellDef="let element">{{ element.variableId }}</td>
              </ng-container>
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Wert</th>
                <td mat-cell *matCellDef="let element">{{ element.value }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['select', 'fileName', 'variableId', 'value']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['select', 'fileName', 'variableId', 'value'];"></tr>
            </table>
            <mat-paginator #variablePaginator
                           [pageSize]="variablePageSize"
                           [pageSizeOptions]="pageSizeOptions"
                           [length]="totalInvalidVariables"
                           [pageIndex]="currentVariablePage - 1"
                           (page)="onVariablePageChange($event)"
                           aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      } @else if (!isVariableValidationRunning && invalidVariables.length === 0 && totalInvalidVariables === 0 && validateVariablesWasRun) {
        <div class="validation-result validation-success">
          <mat-icon>check_circle</mat-icon>
          <span>Prüfung bestanden: Keine ungültigen Variablen gefunden.</span>
        </div>
      }
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header
        class="validation-panel-header"
        [ngClass]="{
          'validation-running': getValidationStatus('variableTypes') === 'running',
          'validation-error': getValidationStatus('variableTypes') === 'failed',
          'validation-success': getValidationStatus('variableTypes') === 'success',
          'validation-not-run': getValidationStatus('variableTypes') === 'not-run'
        }">
        <mat-panel-title>
          <mat-icon *ngIf="getValidationStatus('variableTypes') === 'running'">hourglass_empty</mat-icon>
          <mat-icon *ngIf="getValidationStatus('variableTypes') === 'failed'">error</mat-icon>
          <mat-icon *ngIf="getValidationStatus('variableTypes') === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="getValidationStatus('variableTypes') === 'not-run'">radio_button_unchecked</mat-icon>
          <span style="margin-left: 8px;">{{ getValidationLabel('variableTypes') }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (getValidationStatus('variableTypes') === 'running') {
            <span class="validation-badge validation-running">Läuft…</span>
          } @else if (getValidationStatus('variableTypes') === 'failed') {
            <span class="validation-badge validation-error">{{ totalInvalidTypeVariables }} ungültig</span>
          } @else if (getValidationStatus('variableTypes') === 'success') {
            <span class="validation-badge validation-success">OK</span>
          } @else {
            <span class="validation-badge validation-not-run">Nicht ausgeführt</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="validation-details">
        <p class="validation-details-intro">Prüft, ob der Wert der Variable dem definierten Typ entspricht (string, integer, number, boolean, json).</p>

        <div class="validation-guidance">
          <div class="info-banner">
            <mat-icon>help</mat-icon>
            <span><strong>Warum ist das wichtig?</strong> {{ getValidationWhyText('variableTypes') }}</span>
          </div>
          <div class="info-banner">
            <mat-icon>build</mat-icon>
            <span><strong>So beheben Sie es:</strong> {{ getValidationFixHint('variableTypes') }}</span>
          </div>
        </div>

        <div class="validation-actions">
          <button mat-button (click)="validateVariableTypes()" [disabled]="isAnyValidationRunning()">Variablentypen prüfen</button>
        </div>
      </div>
      @if (isVariableTypeValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Variablentypen werden geprüft...</p>
        </div>
      }
      @if (invalidTypeVariables.length > 0 || totalInvalidTypeVariables > 0) {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>Prüfung fehlgeschlagen: {{ totalInvalidTypeVariables }} ungültige Variablenwerte gefunden.</span>
        </div>
        @if (invalidTypeVariables.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleTypeExpansion()">
              {{ expandedTypePanel ? 'Details ausblenden' : 'Details anzeigen' }}
            </button>
            <button mat-button (click)="selectAllTypeResponses()">Alle auswählen</button>
            <button mat-button (click)="deselectAllTypeResponses()">Auswahl aufheben</button>
            <button mat-button color="warn" (click)="deleteSelectedTypeResponses()" [disabled]="isDeletingResponses || selectedTypeResponses.size === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Ausgewählte löschen ({{ selectedTypeResponses.size }})
              }
            </button>
            <button mat-button color="warn" (click)="deleteAllTypeResponses()" [disabled]="isDeletingResponses || invalidTypeVariables.length === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Alle löschen ({{ totalInvalidTypeVariables }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedTypePanel">
            <table mat-table [dataSource]="paginatedTypeVariables">
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>Auswählen</th>
                <td mat-cell *matCellDef="let element">
                  <input type="checkbox"
                         [checked]="isTypeResponseSelected(element.responseId)"
                         (change)="toggleTypeResponseSelection(element.responseId)"
                         [disabled]="!element.responseId">
                </td>
              </ng-container>
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>Dateiname</th>
                <td mat-cell *matCellDef="let element">
                  <a href="javascript:void(0)" (click)="showUnitXml(element.fileName)">{{ element.fileName }}</a>
                </td>
              </ng-container>
              <ng-container matColumnDef="variableId">
                <th mat-header-cell *matHeaderCellDef>Variablen-ID</th>
                <td mat-cell *matCellDef="let element">{{ element.variableId }}</td>
              </ng-container>
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Wert</th>
                <td mat-cell *matCellDef="let element">{{ element.value }}</td>
              </ng-container>
              <ng-container matColumnDef="expectedType">
                <th mat-header-cell *matHeaderCellDef>Erwarteter Typ</th>
                <td mat-cell *matCellDef="let element">{{ element.expectedType }}</td>
              </ng-container>
              <ng-container matColumnDef="errorReason">
                <th mat-header-cell *matHeaderCellDef>Fehlergrund</th>
                <td mat-cell *matCellDef="let element">{{ element.errorReason }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['select', 'fileName', 'variableId', 'value', 'expectedType', 'errorReason']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['select', 'fileName', 'variableId', 'value', 'expectedType', 'errorReason'];"></tr>
            </table>
            <mat-paginator #variableTypePaginator
                           [pageSize]="typeVariablePageSize"
                           [pageSizeOptions]="pageSizeOptions"
                           [length]="totalInvalidTypeVariables"
                           [pageIndex]="currentTypeVariablePage - 1"
                           (page)="onTypeVariablePageChange($event)"
                           aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      } @else if (!isVariableTypeValidationRunning && invalidTypeVariables.length === 0 && totalInvalidTypeVariables === 0 && validateVariableTypesWasRun) {
        <div class="validation-result validation-success">
          <mat-icon>check_circle</mat-icon>
          <span>Prüfung bestanden: Keine ungültigen Variablenwerte gefunden.</span>
        </div>
      }
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header
        class="validation-panel-header"
        [ngClass]="{
          'validation-running': getValidationStatus('responseStatus') === 'running',
          'validation-error': getValidationStatus('responseStatus') === 'failed',
          'validation-success': getValidationStatus('responseStatus') === 'success',
          'validation-not-run': getValidationStatus('responseStatus') === 'not-run'
        }">
        <mat-panel-title>
          <mat-icon *ngIf="getValidationStatus('responseStatus') === 'running'">hourglass_empty</mat-icon>
          <mat-icon *ngIf="getValidationStatus('responseStatus') === 'failed'">error</mat-icon>
          <mat-icon *ngIf="getValidationStatus('responseStatus') === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="getValidationStatus('responseStatus') === 'not-run'">radio_button_unchecked</mat-icon>
          <span style="margin-left: 8px;">{{ getValidationLabel('responseStatus') }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (getValidationStatus('responseStatus') === 'running') {
            <span class="validation-badge validation-running">Läuft…</span>
          } @else if (getValidationStatus('responseStatus') === 'failed') {
            <span class="validation-badge validation-error">{{ totalInvalidStatusVariables }} ungültig</span>
          } @else if (getValidationStatus('responseStatus') === 'success') {
            <span class="validation-badge validation-success">OK</span>
          } @else {
            <span class="validation-badge validation-not-run">Nicht ausgeführt</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="validation-details">
        <p class="validation-details-intro">Prüft, ob der Status der Antwort gültig ist (gemäß Unit.xml).</p>

        <div class="validation-guidance">
          <div class="info-banner">
            <mat-icon>help</mat-icon>
            <span><strong>Warum ist das wichtig?</strong> {{ getValidationWhyText('responseStatus') }}</span>
          </div>
          <div class="info-banner">
            <mat-icon>build</mat-icon>
            <span><strong>So beheben Sie es:</strong> {{ getValidationFixHint('responseStatus') }}</span>
          </div>
        </div>

        <div class="validation-actions">
          <button mat-button (click)="validateResponseStatus()" [disabled]="isAnyValidationRunning()">Antwortstatus prüfen</button>
        </div>
      </div>
      @if (isResponseStatusValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Antwortstatus wird geprüft...</p>
        </div>
      }
      @if (invalidStatusVariables.length > 0 || totalInvalidStatusVariables > 0) {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>Prüfung fehlgeschlagen: {{ totalInvalidStatusVariables }} ungültige Antwortstatus gefunden.</span>
        </div>
        @if (invalidStatusVariables.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleStatusExpansion()">
              {{ expandedStatusPanel ? 'Details ausblenden' : 'Details anzeigen' }}
            </button>
            <button mat-button (click)="selectAllStatusResponses()">Alle auswählen</button>
            <button mat-button (click)="deselectAllStatusResponses()">Auswahl aufheben</button>
            <button mat-button color="warn" (click)="deleteSelectedStatusResponses()" [disabled]="isDeletingResponses || selectedStatusResponses.size === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Ausgewählte löschen ({{ selectedStatusResponses.size }})
              }
            </button>
            <button mat-button color="warn" (click)="deleteAllStatusResponses()" [disabled]="isDeletingResponses || invalidStatusVariables.length === 0">
              @if (isDeletingResponses) {
                <mat-spinner diameter="20"></mat-spinner> Löschen...
              } @else {
                Alle löschen ({{ totalInvalidStatusVariables }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedStatusPanel">
            <table mat-table [dataSource]="paginatedStatusVariables">
              <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>Auswählen</th>
                <td mat-cell *matCellDef="let element">
                  <input type="checkbox"
                         [checked]="isStatusResponseSelected(element.responseId)"
                         (change)="toggleStatusResponseSelection(element.responseId)"
                         [disabled]="!element.responseId">
                </td>
              </ng-container>
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>Dateiname</th>
                <td mat-cell *matCellDef="let element">
                  <a href="javascript:void(0)" (click)="showUnitXml(element.fileName)">{{ element.fileName }}</a>
                </td>
              </ng-container>
              <ng-container matColumnDef="variableId">
                <th mat-header-cell *matHeaderCellDef>Variablen-ID</th>
                <td mat-cell *matCellDef="let element">{{ element.variableId }}</td>
              </ng-container>
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>Wert</th>
                <td mat-cell *matCellDef="let element">{{ element.value }}</td>
              </ng-container>
              <ng-container matColumnDef="errorReason">
                <th mat-header-cell *matHeaderCellDef>Fehlergrund</th>
                <td mat-cell *matCellDef="let element">{{ element.errorReason }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['select', 'fileName', 'variableId', 'value', 'errorReason']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['select', 'fileName', 'variableId', 'value', 'errorReason'];"></tr>
            </table>
            <mat-paginator #statusVariablePaginator
                           [pageSize]="statusVariablePageSize"
                           [pageSizeOptions]="pageSizeOptions"
                           [length]="totalInvalidStatusVariables"
                           [pageIndex]="currentStatusVariablePage - 1"
                           (page)="onStatusVariablePageChange($event)"
                           aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      } @else if (!isResponseStatusValidationRunning && invalidStatusVariables.length === 0 && totalInvalidStatusVariables === 0 && validateResponseStatusWasRun) {
        <div class="validation-result validation-success">
          <mat-icon>check_circle</mat-icon>
          <span>Prüfung bestanden: Keine ungültigen Antwortstatus gefunden.</span>
        </div>
      }
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header
        class="validation-panel-header"
        [ngClass]="{
          'validation-running': getValidationStatus('duplicateResponses') === 'running',
          'validation-error': getValidationStatus('duplicateResponses') === 'failed',
          'validation-success': getValidationStatus('duplicateResponses') === 'success',
          'validation-not-run': getValidationStatus('duplicateResponses') === 'not-run'
        }">
        <mat-panel-title>
          <mat-icon *ngIf="getValidationStatus('duplicateResponses') === 'running'">hourglass_empty</mat-icon>
          <mat-icon *ngIf="getValidationStatus('duplicateResponses') === 'failed'">error</mat-icon>
          <mat-icon *ngIf="getValidationStatus('duplicateResponses') === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="getValidationStatus('duplicateResponses') === 'not-run'">radio_button_unchecked</mat-icon>
          <span style="margin-left: 8px;">{{ getValidationLabel('duplicateResponses') }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (getValidationStatus('duplicateResponses') === 'running') {
            <span class="validation-badge validation-running">Läuft…</span>
          } @else if (getValidationStatus('duplicateResponses') === 'failed') {
            <span class="validation-badge validation-error">{{ totalDuplicateResponses }} Duplikate</span>
          } @else if (getValidationStatus('duplicateResponses') === 'success') {
            <span class="validation-badge validation-success">OK</span>
          } @else {
            <span class="validation-badge validation-not-run">Nicht ausgeführt</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="validation-details">
        <p class="validation-details-intro">Prüft, ob doppelte Antworten für die gleiche Variable, Unit und Testperson existieren.</p>

        <div class="validation-guidance">
          <div class="info-banner">
            <mat-icon>help</mat-icon>
            <span><strong>Warum ist das wichtig?</strong> {{ getValidationWhyText('duplicateResponses') }}</span>
          </div>
          <div class="info-banner">
            <mat-icon>build</mat-icon>
            <span><strong>So beheben Sie es:</strong> {{ getValidationFixHint('duplicateResponses') }}</span>
          </div>
        </div>

        <div class="validation-actions">
          <button mat-button (click)="validateDuplicateResponses()" [disabled]="isAnyValidationRunning()">Duplikate prüfen</button>
        </div>
      </div>
      @if (isDuplicateResponsesValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Duplikate werden geprüft...</p>
        </div>
      }
      @if (duplicateResponses.length > 0 || totalDuplicateResponses > 0) {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>Prüfung fehlgeschlagen: {{ totalDuplicateResponses }} doppelte Antworten gefunden.</span>
        </div>
        @if (duplicateResponses.length > 0) {
          <div class="actions-container">
            <button mat-button (click)="toggleDuplicateResponsesExpansion()">
              {{ expandedDuplicateResponsesPanel ? 'Details ausblenden' : 'Details anzeigen' }}
            </button>
            <button mat-button color="primary" (click)="resolveDuplicateResponses()" [disabled]="isResolvingDuplicateResponses || !hasSelectedDuplicateResponses()">
              @if (isResolvingDuplicateResponses) {
                <mat-spinner diameter="20"></mat-spinner> Wird bearbeitet...
              } @else {
                Ausgewählte behalten ({{ getSelectedDuplicateResponsesCount() }})
              }
            </button>
            <button mat-button color="warn" (click)="resolveAllDuplicateResponses()" [disabled]="isResolvingDuplicateResponses || duplicateResponses.length === 0">
              @if (isResolvingDuplicateResponses) {
                <mat-spinner diameter="20"></mat-spinner> Wird bearbeitet...
              } @else {
                Alle automatisch auflösen ({{ totalDuplicateResponses }})
              }
            </button>
          </div>

          <mat-expansion-panel [expanded]="expandedDuplicateResponsesPanel">
            <div class="duplicate-responses-container">
              @for (duplicate of paginatedDuplicateResponses; track duplicate.key) {
                <div class="duplicate-response-item">
                  <div class="duplicate-response-header">
                    <div class="duplicate-response-info">
                      <strong>Unit:</strong> {{ duplicate.unitName }} |
                      <strong>Variable:</strong> {{ duplicate.variableId }} |
                      <strong>Subform:</strong> {{ duplicate.subform }} |
                      <strong>Testperson:</strong> {{ duplicate.testTakerLogin }} |
                      <strong>Booklet:</strong> {{ duplicate.bookletName }}
                    </div>
                  </div>
                  <div class="actions-container" style="margin-top: 8px;">
                    <span>
                      <strong>{{ getDuplicateConflictLabel(duplicate) }}</strong>
                      @if (isDuplicateGroupTouched(duplicate)) {
                        <span> | Auswahl gesetzt</span>
                      } @else {
                        <span> | Keine Auswahl gesetzt</span>
                      }
                    </span>
                    <button mat-button (click)="selectSuggestedDuplicateResponse(duplicate)" [disabled]="isResolvingDuplicateResponses">
                      Vorschlag übernehmen
                    </button>
                    <button mat-button color="primary" (click)="resolveDuplicateGroup(duplicate)" [disabled]="isResolvingDuplicateResponses || !isDuplicateGroupTouched(duplicate)">
                      Auflösen
                    </button>
                  </div>
                  <div class="duplicate-response-duplicates">
                    <table class="duplicate-response-table">
                      <thead>
                        <tr>
                          <th>Auswählen</th>
                          <th>Antwort-ID</th>
                          <th>Wert</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (responseDuplicate of duplicate.duplicates; track responseDuplicate.responseId) {
                          <tr [ngClass]="{ 'duplicate-row-selected': isDuplicateRowSelected(duplicate, responseDuplicate.responseId) }">
                            <td>
                              <input type="radio"
                                     name="duplicate_{{ duplicate.key }}"
                                     [value]="responseDuplicate.responseId"
                                     [checked]="isSelectedDuplicateResponse(duplicate, responseDuplicate.responseId)"
                                     (change)="selectDuplicateResponse(duplicate, responseDuplicate.responseId)">
                            </td>
                            <td>{{ responseDuplicate.responseId }}</td>
                            <td [ngClass]="{ 'duplicate-cell-conflict': isDuplicateValueConflicting(duplicate, responseDuplicate.responseId), 'duplicate-cell-selected': isDuplicateRowSelected(duplicate, responseDuplicate.responseId) }">
                              {{ responseDuplicate.value }}
                            </td>
                            <td [ngClass]="{ 'duplicate-cell-conflict': isDuplicateStatusConflicting(duplicate, responseDuplicate.responseId), 'duplicate-cell-selected': isDuplicateRowSelected(duplicate, responseDuplicate.responseId) }">
                              {{ responseDuplicate.status }}
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              }
            </div>
            <mat-paginator #duplicateResponsesPaginator
                           [pageSize]="duplicateResponsesPageSize"
                           [pageSizeOptions]="pageSizeOptions"
                           [length]="totalDuplicateResponses"
                           [pageIndex]="currentDuplicateResponsesPage - 1"
                           (page)="onDuplicateResponsesPageChange($event)"
                           aria-label="Seite auswählen">
            </mat-paginator>
          </mat-expansion-panel>
        }
      } @else if (!isDuplicateResponsesValidationRunning && duplicateResponses.length === 0 && totalDuplicateResponses === 0 && validateDuplicateResponsesWasRun) {
        <div class="validation-result validation-success">
          <mat-icon>check_circle</mat-icon>
          <span>Prüfung bestanden: Keine doppelten Antworten gefunden.</span>
        </div>
      }
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header
        class="validation-panel-header"
        [ngClass]="{
          'validation-running': getValidationStatus('groupResponses') === 'running',
          'validation-error': getValidationStatus('groupResponses') === 'failed',
          'validation-success': getValidationStatus('groupResponses') === 'success',
          'validation-not-run': getValidationStatus('groupResponses') === 'not-run'
        }">
        <mat-panel-title>
          <mat-icon *ngIf="getValidationStatus('groupResponses') === 'running'">hourglass_empty</mat-icon>
          <mat-icon *ngIf="getValidationStatus('groupResponses') === 'failed'">error</mat-icon>
          <mat-icon *ngIf="getValidationStatus('groupResponses') === 'success'">check_circle</mat-icon>
          <mat-icon *ngIf="getValidationStatus('groupResponses') === 'not-run'">radio_button_unchecked</mat-icon>
          <span style="margin-left: 8px;">{{ getValidationLabel('groupResponses') }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (getValidationStatus('groupResponses') === 'running') {
            <span class="validation-badge validation-running">Läuft…</span>
          } @else if (getValidationStatus('groupResponses') === 'failed') {
            <span class="validation-badge validation-error">Unvollständig</span>
          } @else if (getValidationStatus('groupResponses') === 'success') {
            <span class="validation-badge validation-success">OK</span>
          } @else {
            <span class="validation-badge validation-not-run">Nicht ausgeführt</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="validation-details">
        <p class="validation-details-intro">Prüft, ob Antworten für alle Testperson-Gruppen vorliegen.</p>

        <div class="validation-guidance">
          <div class="info-banner">
            <mat-icon>help</mat-icon>
            <span><strong>Warum ist das wichtig?</strong> {{ getValidationWhyText('groupResponses') }}</span>
          </div>
          <div class="info-banner">
            <mat-icon>build</mat-icon>
            <span><strong>So beheben Sie es:</strong> {{ getValidationFixHint('groupResponses') }}</span>
          </div>
        </div>

        <div class="validation-actions">
          <button mat-button (click)="validateGroupResponses()" [disabled]="isAnyValidationRunning()">Gruppenantworten prüfen</button>
        </div>
      </div>
      @if (isGroupResponsesValidationRunning) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Gruppenantworten werden geprüft...</p>
        </div>
      }
      @if (groupResponsesResult) {
        <div>
          @if (groupResponsesResult.testTakersFound) {
            <p>Testpersonen-Datei gefunden und analysiert.</p>
          } @else {
            <div class="validation-result validation-error">
              <mat-icon>error</mat-icon>
              <span>Prüfung fehlgeschlagen: Keine Testpersonen-Datei (TestTakers) gefunden.</span>
            </div>
          }
          @if (groupResponsesResult.groupsWithResponses.length > 0) {
            @if (groupResponsesResult.allGroupsHaveResponses) {
              <div class="validation-result validation-success">
                <mat-icon>check_circle</mat-icon>
                <span>Prüfung bestanden: Alle Gruppen haben mindestens eine Antwort.</span>
              </div>
            } @else {
              <div class="validation-result validation-error">
                <mat-icon>error</mat-icon>
                <span>Prüfung fehlgeschlagen: Einige Gruppen haben keine Antworten.</span>
              </div>
            }
            <div class="actions-container">
              <button mat-button (click)="toggleGroupResponsesExpansion()">
                {{ expandedGroupResponsesPanel ? 'Liste einklappen' : 'Liste ausklappen' }}
              </button>
            </div>

            <mat-expansion-panel [expanded]="expandedGroupResponsesPanel">
              <table mat-table [dataSource]="paginatedGroupResponses">
                <ng-container matColumnDef="group">
                  <th mat-header-cell *matHeaderCellDef>Gruppe</th>
                  <td mat-cell *matCellDef="let element">{{ element.group }}</td>
                </ng-container>
                <ng-container matColumnDef="hasResponse">
                  <th mat-header-cell *matHeaderCellDef>Hat Antwort</th>
                  <td mat-cell *matCellDef="let element">
                    @if (element.hasResponse) {
                      <mat-icon color="primary">check_circle</mat-icon>
                    } @else {
                      <mat-icon color="warn">error</mat-icon>
                    }
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['group', 'hasResponse']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['group', 'hasResponse'];"></tr>
              </table>
              <mat-paginator #groupResponsesPaginator
                           [pageSize]="groupResponsesPageSize"
                           [pageSizeOptions]="pageSizeOptions"
                           [length]="totalGroupResponses"
                           [pageIndex]="currentGroupResponsesPage - 1"
                           (page)="onGroupResponsesPageChange($event)"
                           aria-label="Seite auswählen">
              </mat-paginator>
            </mat-expansion-panel>
          } @else if (groupResponsesValidationWasRun) {
            <div class="validation-result validation-error">
              <mat-icon>error</mat-icon>
              <span>Prüfung fehlgeschlagen: Keine gültigen Gruppen gefunden.</span>
            </div>
          }
        </div>
      }
    </mat-expansion-panel>
  </mat-accordion>
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-button mat-dialog-close>Abbrechen</button>
  <button mat-button color="primary" (click)="closeWithResults()">Übernehmen</button>
</mat-dialog-actions>
