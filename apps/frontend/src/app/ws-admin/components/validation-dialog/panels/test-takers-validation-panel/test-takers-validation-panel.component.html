<mat-expansion-panel>
  <mat-expansion-panel-header>
    <coding-box-validation-panel-header
      title="Testpersonen-Prüfung"
      [status]="status"
      [errorCount]="errorCount">
    </coding-box-validation-panel-header>
  </mat-expansion-panel-header>

  <coding-box-validation-guidance
    description="Prüft, ob für jede Testperson in der Datenbank ein entsprechender Eintrag in den TestTakers XML-Dateien existiert."
    whyText="Fehlende TestTakers-Einträge können zu Problemen beim Export und bei der Datenanalyse führen."
    fixHint="Laden Sie die fehlenden TestTakers XML-Dateien hoch oder entfernen Sie die betroffenen Testpersonen aus der Datenbank.">
  </coding-box-validation-guidance>

  <div class="validation-actions">
    <button mat-button (click)="onValidate()" [disabled]="isRunning || disabled">
      Testpersonen prüfen
    </button>
  </div>

  @if (isRunning) {
    <div class="loading-container">
      <mat-spinner class="mat-spinner"></mat-spinner>
      <p class="loading-text">Testpersonen werden geprüft...</p>
    </div>
  }

  @if (result) {
    <div>
      @if (!result.testTakersFound) {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>Prüfung fehlgeschlagen: Keine TestTakers gefunden.</span>
        </div>
      }

      @if (result.missingPersons.length > 0) {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>
            Prüfung fehlgeschlagen: {{ result.missingPersons.length }} Testpersonen wurden nicht in den TestTakers XML-Dateien gefunden.
          </span>
        </div>

        <div class="actions-container">
          <button mat-button (click)="toggleExpansion()">
            {{ expandedPanel ? 'Details ausblenden' : 'Details anzeigen' }}
          </button>
        </div>

        <mat-expansion-panel [expanded]="expandedPanel">
          <table mat-table [dataSource]="paginatedMissingPersons">
            <ng-container matColumnDef="group">
              <th mat-header-cell *matHeaderCellDef>Gruppe</th>
              <td mat-cell *matCellDef="let element">{{ element.group }}</td>
            </ng-container>

            <ng-container matColumnDef="login">
              <th mat-header-cell *matHeaderCellDef>Login</th>
              <td mat-cell *matCellDef="let element">{{ element.login }}</td>
            </ng-container>

            <ng-container matColumnDef="code">
              <th mat-header-cell *matHeaderCellDef>Code</th>
              <td mat-cell *matCellDef="let element">{{ element.code }}</td>
            </ng-container>

            <ng-container matColumnDef="reason">
              <th mat-header-cell *matHeaderCellDef>Grund</th>
              <td mat-cell *matCellDef="let element">{{ element.reason }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let _row; columns: displayedColumns;"></tr>
          </table>
        </mat-expansion-panel>
      } @else if (wasRun) {
        <div class="validation-result validation-success">
          <mat-icon>check_circle</mat-icon>
          <span>Prüfung bestanden: Alle Testpersonen wurden in den TestTakers XML-Dateien gefunden.</span>
        </div>
      }
    </div>
  }
</mat-expansion-panel>
