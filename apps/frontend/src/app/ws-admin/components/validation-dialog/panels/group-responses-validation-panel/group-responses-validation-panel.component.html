<mat-expansion-panel>
  <mat-expansion-panel-header>
    <coding-box-validation-panel-header
      title="Gruppenantworten-Prüfung"
      [status]="status">
    </coding-box-validation-panel-header>
  </mat-expansion-panel-header>

  <coding-box-validation-guidance
    description="Prüft, ob Antworten für alle Testperson-Gruppen vorliegen."
    whyText="Fehlende Antworten für bestimmte Gruppen können auf Probleme beim Datenimport oder fehlende Testdurchführungen hinweisen."
    fixHint="Importieren Sie die fehlenden Antwortdaten oder überprüfen Sie, ob alle Gruppen den Test durchgeführt haben.">
  </coding-box-validation-guidance>

  <div class="validation-actions">
    <button mat-button (click)="onValidate()" [disabled]="isRunning || disabled">
      Gruppenantworten prüfen
    </button>
  </div>

  @if (isRunning) {
    <div class="loading-container">
      <mat-spinner class="mat-spinner"></mat-spinner>
      <p class="loading-text">Gruppenantworten werden geprüft...</p>
    </div>
  }

  @if (result) {
    <div>
      @if (result.testTakersFound) {
        <p>Testpersonen-Datei gefunden und analysiert.</p>
      } @else {
        <div class="validation-result validation-error">
          <mat-icon>error</mat-icon>
          <span>Prüfung fehlgeschlagen: Keine Testpersonen-Datei (TestTakers) gefunden.</span>
        </div>
      }

      @if (result.groupsWithResponses.length > 0) {
        @if (result.allGroupsHaveResponses) {
          <div class="validation-result validation-success">
            <mat-icon>check_circle</mat-icon>
            <span>Prüfung bestanden: Alle Gruppen haben mindestens eine Antwort.</span>
          </div>
        } @else {
          <div class="validation-result validation-error">
            <mat-icon>error</mat-icon>
            <span>Prüfung fehlgeschlagen: Einige Gruppen haben keine Antworten.</span>
          </div>
        }

        <div class="actions-container">
          <button mat-button (click)="toggleExpansion()">
            {{ expandedPanel ? 'Liste einklappen' : 'Liste ausklappen' }}
          </button>
        </div>

        <mat-expansion-panel [expanded]="expandedPanel">
          <table mat-table [dataSource]="paginatedGroupResponses">
            <ng-container matColumnDef="group">
              <th mat-header-cell *matHeaderCellDef>Gruppe</th>
              <td mat-cell *matCellDef="let element">{{ element.group }}</td>
            </ng-container>

            <ng-container matColumnDef="hasResponse">
              <th mat-header-cell *matHeaderCellDef>Hat Antwort</th>
              <td mat-cell *matCellDef="let element">
                @if (element.hasResponse) {
                  <mat-icon color="primary">check_circle</mat-icon>
                } @else {
                  <mat-icon color="warn">error</mat-icon>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let _row; columns: displayedColumns;"></tr>
          </table>
        </mat-expansion-panel>
      }
    </div>
  }
</mat-expansion-panel>
