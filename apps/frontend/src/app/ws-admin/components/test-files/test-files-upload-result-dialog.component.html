<h2 mat-dialog-title>Upload-Ergebnis</h2>

<div mat-dialog-content>
  <p class="summary">
    Versuch: {{ attempted }}
    <span class="sep">|</span>
    Erfolgreich: {{ uploadedCount }}
    <span class="sep">|</span>
    Fehlgeschlagen: {{ failedCount }}
    <span class="sep">|</span>
    Nicht überschrieben: {{ remainingConflictsCount }}
    @if (overwriteSelectedCount && overwriteSelectedCount > 0) {
    <span class="sep">|</span>
    Ausgewählt zum Überschreiben: {{ overwriteSelectedCount }}
    }
  </p>

  <mat-form-field appearance="outline" style="width: 100%">
    <mat-label>Suche</mat-label>
    <input
      matInput
      [(ngModel)]="filterText"
      placeholder="Dateiname, ID, Typ oder Grund..."
    />
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>

  <mat-tab-group>
    <mat-tab label="Erfolgreich ({{ uploadedCount }})">
      <cdk-virtual-scroll-viewport itemSize="68" class="viewport">
        <div
          *cdkVirtualFor="
            let f of filteredUploadedFiles;
            trackBy: trackByUploaded
          "
          class="row"
        >
          <div class="main">
            <div class="title">{{ f.filename }}</div>
            <div class="meta">
              @if (f.fileId) { <span>ID: {{ f.fileId }}</span> } @if
              (f.fileType) { <span>Typ: {{ f.fileType }}</span> }
            </div>
          </div>
        </div>
      </cdk-virtual-scroll-viewport>
    </mat-tab>

    <mat-tab label="Fehlgeschlagen ({{ failedCount }})">
      <cdk-virtual-scroll-viewport itemSize="68" class="viewport">
        <div
          *cdkVirtualFor="let f of filteredFailedFiles; trackBy: trackByFailed"
          class="row"
        >
          <div class="main">
            <div class="title">{{ f.filename }}</div>
            @if (f.reason) {
            <div class="sub">{{ f.reason }}</div>
            }
          </div>
        </div>
      </cdk-virtual-scroll-viewport>
    </mat-tab>

    <mat-tab label="Nicht überschrieben ({{ remainingConflictsCount }})">
      <cdk-virtual-scroll-viewport itemSize="68" class="viewport">
        <div
          *cdkVirtualFor="
            let f of filteredRemainingConflicts;
            trackBy: trackByConflict
          "
          class="row"
        >
          <div class="main">
            <div class="title">{{ f.filename }}</div>
            <div class="meta">
              <span>ID: {{ f.fileId }}</span>
              @if (f.fileType) { <span>Typ: {{ f.fileType }}</span> }
            </div>
          </div>
        </div>
      </cdk-virtual-scroll-viewport>
    </mat-tab>

    @if (issues.length > 0) {
      <mat-tab label="Probleme ({{ issues.length }})">
        <div class="tab-pad">
          @if (filteredIssues.length === 0) {
            <div class="empty">Keine Probleme gefunden.</div>
          } @else {
            <cdk-virtual-scroll-viewport itemSize="60" class="viewport">
              <div *cdkVirtualFor="let i of filteredIssues; trackBy: trackByIssue" class="row issue-row" [class.error]="i.level === 'error'" [class.warning]="i.level === 'warning'">
                <div class="main issue-main">
                  <div class="title issue-title">
                    <span class="pill" [class.error]="i.level === 'error'" [class.warning]="i.level === 'warning'">{{ i.level }}</span>
                    <span class="msg">{{ i.message }}</span>
                  </div>
                  <div class="meta issue-meta">
                    @if (i.fileName) { <span>Datei: {{ i.fileName }}</span> }
                    @if (i.rowIndex !== null && i.rowIndex !== undefined) { <span>Zeile: {{ i.rowIndex }}</span> }
                  </div>
                </div>
              </div>
            </cdk-virtual-scroll-viewport>
          }
        </div>
      </mat-tab>
    }
  </mat-tab-group>
</div>

<div mat-dialog-actions align="end">
  <button mat-button type="button" (click)="close()">Schließen</button>
</div>
