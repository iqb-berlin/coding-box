<div class="fx-column-start-start fx-gap-10 container">
  <div>
    <div class="fx-row-center-center-stretch fx-gap-20 upload-buttons">
      <a mat-raised-button color="primary" (click)="testCenterImport()">
        <mat-icon>upload</mat-icon>
        Testcenter Import
      </a>
      <a mat-raised-button color="primary" (click)=hiddenResponsesFileInput.click()>
        <mat-icon>upload</mat-icon>
        Antworten hochladen
      </a>
      <a mat-raised-button color="primary" (click)=hiddenLogsFileInput.click()>
        <mat-icon>upload</mat-icon>
        Logs hochladen
      </a>
      <a mat-raised-button color="primary" [disabled]="selection.selected.length === 0" (click)="deleteSelectedPersons()">
        <mat-icon>delete</mat-icon>
        Testperson(en) löschen
      </a>
      <a mat-raised-button color="primary" [disabled]="selection.selected.length === 0" (click)="codeSelectedPersons()">
        <mat-icon>code</mat-icon>
        Kodieren
      </a>
      <a mat-raised-button color="primary" (click)="fetchBaseVariables()">
        <mat-icon>list</mat-icon>
        Basisvariablen anzeigen
      </a>
      <a mat-raised-button color="primary" (click)="validateResponses()">
        <mat-icon>verified</mat-icon>
        Validierung
      </a>
      <a mat-raised-button color="primary" (click)="validateTestResults()">
        <mat-icon>rule</mat-icon>
        Testergebnisse validieren
      </a>
    </div>
  </div>
  <input #hiddenResponsesFileInput type="file"
    name="files"
    accept=".json,.zip,.csv"
    multiple
    [hidden]="true"
    (change)="onFileSelected($event.currentTarget, 'responses')"/>
  <input #hiddenLogsFileInput type="file"
    name="files"
    accept=".json,.zip,.csv"
    multiple
    [hidden]="true"
    (change)="onFileSelected($event.currentTarget, 'logs')"/>
  @if (isUploadingResults) {
    <div class="loading-container">
      <mat-spinner class="mat-spinner"></mat-spinner>
      <p class="loading-text">Ergebnisse werden hochgeladen...</p>
    </div>
  }

  @if(!isUploadingResults){
    @if ( dataSource && dataSource.data.length) {
      <div class="content-container">
        <div class="data-card">
          <h2 class="section-title">Testpersonen</h2>
          <p class="section-description">Wählen Sie eine Testperson aus, um deren Ergebnisse anzuzeigen</p>
          <mat-divider></mat-divider>

          @if (isLoading) {
            <div class="loading-container">
              <mat-spinner class="mat-spinner"></mat-spinner>
              <p class="loading-text">Daten werden geladen...</p>
            </div>
          }

          @if (!isLoading) {
            <div class="table-section">
              <div class="search-container">
                <mat-icon class="search-icon">search</mat-icon>
                <input matInput (input)="applyFilter($event)" placeholder="Suchen..." class="search-input">
              </div>
              <div class="table-container">
                <mat-table [dataSource]="dataSource" matSort class="persons-table">
                  <ng-container matColumnDef="select">
                    <mat-header-cell *matHeaderCellDef>
                      <mat-checkbox
                        (change)="masterToggle()"
                        [checked]="isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()">
                      </mat-checkbox>
                    </mat-header-cell>
                    <mat-cell *matCellDef="let row">
                      <mat-checkbox
                        (click)="$event.stopPropagation()"
                        (change)="toggleRowSelection(row)"
                        [checked]="selection.isSelected(row)">
                      </mat-checkbox>
                    </mat-cell>
                  </ng-container>
                  <ng-container matColumnDef="code" >
                    <mat-header-cell *matHeaderCellDef mat-sort-header="code">
                      Code
                    </mat-header-cell>
                    <mat-cell *matCellDef="let element">
                      {{element.code}}
                    </mat-cell>
                  </ng-container>
                  <ng-container matColumnDef="group">
                    <mat-header-cell *matHeaderCellDef mat-sort-header="group">{{'test_group.test_group' | translate}}</mat-header-cell>
                    <mat-cell *matCellDef="let element">
                      {{element.group}}
                    </mat-cell>
                  </ng-container>
                  <ng-container matColumnDef="login">
                    <mat-header-cell *matHeaderCellDef mat-sort-header="login">Login</mat-header-cell>
                    <mat-cell *matCellDef="let element">
                      {{element.login}}
                    </mat-cell>
                  </ng-container>
                  <ng-container matColumnDef="uploaded_at">
                    <mat-header-cell *matHeaderCellDef mat-sort-header="uploaded_at">Hinzugefügt am</mat-header-cell>
                    <mat-cell *matCellDef="let element">
                      {{element.uploaded_at | date: 'dd.MM.yyyy HH:mm'}}
                    </mat-cell>
                  </ng-container>
                  <mat-header-row *matHeaderRowDef="displayedColumns;sticky: true"></mat-header-row>
                  <mat-row  (click)="onRowClick(row)"
                    *matRowDef="let row; columns: displayedColumns;"
                  class="clickable-row"></mat-row>
                </mat-table>
              </div>
              <mat-paginator
                [length]="totalRecords"
                [pageSize]="pageSize"
                [pageIndex]="pageIndex"
                [pageSizeOptions]="[50, 100, 200, 500]"
                showFirstLastButtons
                (page)="onPaginatorChange($event)"
                class="paginator">
              </mat-paginator>
            </div>
          }
        </div>

        <div class="results-section">
          <div class="booklets-card">
            <h2 class="section-title">Booklets</h2>
            <p class="section-description">Wählen Sie ein Booklet aus, um dessen Aufgaben anzuzeigen</p>
            <mat-divider></mat-divider>

            <mat-accordion class="accordion">
              @for (booklet of booklets; track booklet) {
                <mat-expansion-panel [expanded]="booklets.length === 1" class="booklet-panel">
                  <mat-expansion-panel-header>
                    <mat-panel-title (click)="setSelectedBooklet(booklet)" class="booklet-title">
                      {{ booklet.name }}
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <div class="booklet-actions">
                    <button mat-stroked-button color="primary" (click)="replayBooklet()" class="action-button">
                      <mat-icon>play_arrow</mat-icon>
                      Replay
                    </button>
                    <button mat-stroked-button color="primary" (click)="openBookletLogsDialog(booklet)" class="action-button">
                      <mat-icon>list</mat-icon>
                      Logs anzeigen
                    </button>
                  </div>
                  @if (hasShortProcessingTime(booklet) || !isBookletComplete(booklet)) {
                    <div class="booklet-warnings">
                      @if (hasShortProcessingTime(booklet)) {
                        <mat-icon
                          class="warning-icon short-time-warning"
                          matTooltip="Kurze Bearbeitungszeit (weniger als 1 Minute)">
                          timer
                        </mat-icon>
                      }
                      @if (!isBookletComplete(booklet)) {
                        <mat-icon
                          class="warning-icon incomplete-warning"
                          matTooltip="Nicht vollständig bearbeitet">
                          warning
                        </mat-icon>
                      }
                    </div>
                  }
                  <mat-divider class="section-divider"></mat-divider>
                  <h3 class="units-title">Aufgaben</h3>
                  <mat-list class="unit-list">
                    @for (unit of booklet.units; track unit) {
                      <mat-list-item
                        (click)="onUnitClick(unit)"
                        class="unit-item">
                        <mat-icon class="unit-icon">assignment</mat-icon>
                        <span class="unit-name">{{ unit?.alias || 'Unbenannte Einheit' }}</span>
                        @if (hasGeogebraResponse(unit)) {
                          <span class="geogebra-tag">Geogebra</span>
                        }
                        @if (unit.id) {
                          <div class="unit-tags-container">
                            @for (tag of getUnitTags(unit.id); track tag) {
                              <div class="unit-tag-item">
                                <span class="unit-tag">{{ tag.tag }}</span>
                              </div>
                            }
                          </div>
                        }
                      </mat-list-item>
                    }
                  </mat-list>
                </mat-expansion-panel>
              }
            </mat-accordion>
          </div>

          @if (responses.length > 0) {
            <div class="responses-card">
              <h2 class="section-title">Antworten</h2>
              <p class="section-description">Antworten für die ausgewählte Aufgabe</p>
              <mat-divider></mat-divider>
              <div class="response-actions">
                <button mat-stroked-button color="primary" (click)="replayUnit()" class="action-button">
                  <mat-icon>play_arrow</mat-icon>
                  Replay
                </button>
                <button mat-stroked-button color="primary" (click)="openUnitLogsDialog()" class="action-button">
                  <mat-icon>list</mat-icon>
                  Logs
                </button>
                <button mat-stroked-button color="primary" (click)="openTagsDialog()" class="action-button">
                  <mat-icon>label</mat-icon>
                  Tags
                </button>
                <!--            <button mat-stroked-button color="primary" (click)="openNotesDialog()" class="action-button">-->
                <!--              <mat-icon>note</mat-icon>-->
                <!--              Notizen-->
              <!--            </button>-->
            </div>
            <div class="var-list">
              @for (response of this.responses; track response) {
                <div
                  class="response-item"
                  >
                  <div class="response-header">
                    <div class="response-content">
                      <div
                        [ngStyle]="{ 'background-color': getColor(response.status) }"
                        class="status-indicator"
                        >
                      </div>
                      <span class="variable-id">{{ response.variableid }}</span>
                      <span class="response-status">{{ response.status }}</span>
                    </div>
                    <button mat-icon-button (click)="response.expanded = !response.expanded" class="expand-button">
                      <mat-icon>{{ response.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </button>
                  </div>
                  @if (response.expanded) {
                    <div class="response-details">
                      @if (response.code) {
                        <div class="detail-row">
                          <span class="detail-label">Code:</span>
                          <span class="detail-value">{{ response.code }}</span>
                        </div>
                      }
                      @if (response.score) {
                        <div class="detail-row">
                          <span class="detail-label">Score:</span>
                          <span class="detail-value">{{ response.score }}</span>
                        </div>
                      }
                      @if (response.codedstatus) {
                        <div class="detail-row">
                          <span class="detail-label">Kodier Status:</span>
                          <span class="detail-value">{{ response.codedstatus }}</span>
                        </div>
                      }
                      <div class="detail-row">
                        <span class="detail-label">Value:</span>
                        <span class="detail-value">{{ response.value | slice:0:1000 }}{{ response.value?.length > 1000 ? '...' : '' }}</span>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        @if (logs?.length > 0) {
          <div class="logs-card">
            <h2 class="section-title">Logs</h2>
            <p class="section-description">Protokolleinträge für die ausgewählte Unit</p>
            <mat-divider></mat-divider>
            <div class="log-list">
              @for (log of this.logs; track log;) {
                <div class="log-item">
                  <div class="log-header">
                    <span class="log-key">{{ log.key }}</span>
                    <span class="log-timestamp">{{ formatTimestamp(log.ts) }}</span>
                  </div>
                  <div class="log-parameter">{{ log.parameter }}</div>
                </div>
              }
            </div>
          </div>
        }
      </div>

    </div>
  } @else {
    <div class="empty-state-container">
      <mat-icon class="empty-state-icon">assignment</mat-icon>
      <h2 class="empty-state-title">Keine Testergebnisse vorhanden</h2>
      <p class="empty-state-description">Laden Sie Antworten oder Logs hoch, um Testergebnisse anzuzeigen.</p>
    </div>
  }
}

</div>

<!-- Base Variables Section -->
@if (showBaseVariables) {
  <div class="base-variables-section">
    <div class="data-card">
      <h2 class="section-title">Basisvariablen</h2>
      <p class="section-description">Liste aller Basisvariablen aus den Unit XML Dateien</p>
      <mat-divider></mat-divider>
      @if (isLoadingBaseVariables) {
        <div class="loading-container">
          <mat-spinner class="mat-spinner"></mat-spinner>
          <p class="loading-text">Basisvariablen werden geladen...</p>
        </div>
      }
      @if (!isLoadingBaseVariables) {
        <div class="base-variables-container">
          <div class="base-variables-header">
            <div class="base-variable-id">ID</div>
            <div class="base-variable-type">Typ</div>
            <div class="base-variable-format">Format</div>
            <div class="base-variable-nullable">Nullable</div>
          </div>
          <div class="base-variables-list">
            @for (variable of baseVariables; track variable) {
              <div class="base-variable-item">
                <div class="base-variable-id">{{ variable.id }}</div>
                <div class="base-variable-type">{{ variable.type }}</div>
                <div class="base-variable-format">{{ variable.format || '-' }}</div>
                <div class="base-variable-nullable">{{ variable.nullable }}</div>
              </div>
            }
          </div>
          @if (baseVariables.length === 0) {
            <div class="empty-state">
              <mat-icon>info</mat-icon>
              <p>Keine Basisvariablen gefunden</p>
            </div>
          }
          <div class="base-variables-actions">
            <button mat-raised-button color="primary" (click)="showBaseVariables = false">
              <mat-icon>close</mat-icon>
              Schließen
            </button>
          </div>
        </div>
      }
    </div>
  </div>
}
