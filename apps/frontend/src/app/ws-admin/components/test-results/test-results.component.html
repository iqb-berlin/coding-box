<div class="fx-column-start-start fx-gap-10  container">
  <div class="fx-row-center-center-stretch fx-gap-20 upload-buttons">
    <a mat-raised-button color="primary" (click)="testCenterImport()">
      <mat-icon>upload</mat-icon>
      Testcenter Import
    </a>
    <a mat-raised-button color="primary" (click)=hiddenResponsesFileInput.click()>
      <mat-icon>upload</mat-icon>
      Antworten hochladen
    </a>
    <a mat-raised-button color="primary" (click)=hiddenLogsFileInput.click()>
      <mat-icon>upload</mat-icon>
      Logs hochladen
    </a>
    <a mat-raised-button color="primary" [disabled]="selection.selected.length === 0" (click)="deleteSelectedPersons()">
      <mat-icon>delete</mat-icon>
      Testperson(en) löschen
    </a>
    <a mat-raised-button color="primary" [disabled]="selection.selected.length === 0" (click)="codeSelectedPersons()">
      <mat-icon>code</mat-icon>
      Kodieren
    </a>
  </div>
  <input #hiddenResponsesFileInput type="file"
         name="files"
         accept=".json,.zip,.csv"
         multiple
         [hidden]="true"
         (change)="onFileSelected($event.currentTarget, 'responses')"/>
  <input #hiddenLogsFileInput type="file"
         name="files"
         accept=".json,.zip,.csv"
         multiple
         [hidden]="true"
         (change)="onFileSelected($event.currentTarget, 'logs')"/>
  <mat-spinner *ngIf="isUploadingResults" class="mat-spinner"></mat-spinner>
@if(!isUploadingResults){
  @if ( dataSource && dataSource.data.length) {
    <div class="fx-row-space-between-start">
      <mat-spinner *ngIf="isLoading" class="mat-spinner"></mat-spinner>
      <div *ngIf="!isLoading">
        <div>
          <mat-label>Filter</mat-label>
          <input matInput (input)="applyFilter($event)" placeholder="Suchtext eingeben">
        </div>
        <div class="table-container">
          <div >
            <mat-table [dataSource]="dataSource" matSort>
              <ng-container matColumnDef="select">
                <mat-header-cell *matHeaderCellDef>
                  <mat-checkbox
                    (change)="masterToggle()"
                    [checked]="isAllSelected()"
                    [indeterminate]="selection.hasValue() && !isAllSelected()">
                  </mat-checkbox>
                </mat-header-cell>
                <mat-cell *matCellDef="let row">
                  <mat-checkbox
                    (click)="$event.stopPropagation()"
                    (change)="toggleRowSelection(row)"
                    [checked]="selection.isSelected(row)">
                  </mat-checkbox>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="code" >
                <mat-header-cell *matHeaderCellDef mat-sort-header="code">
                </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  {{element.code}}
                </mat-cell>
              </ng-container>
              <ng-container matColumnDef="group">
                <mat-header-cell *matHeaderCellDef mat-sort-header="group">{{'test_group.test_group' | translate}}</mat-header-cell>
                <mat-cell *matCellDef="let element">
                  {{element.group}}
                </mat-cell>
              </ng-container>
              <ng-container matColumnDef="login">
                <mat-header-cell *matHeaderCellDef mat-sort-header="login">Login</mat-header-cell>
                <mat-cell *matCellDef="let element">
                  {{element.login}}
                </mat-cell>
              </ng-container>
              <ng-container matColumnDef="uploaded_at">
                <mat-header-cell *matHeaderCellDef mat-sort-header="uploaded_at">Hinzugefügt am</mat-header-cell>
                <mat-cell *matCellDef="let element">
                  {{element.uploaded_at | date: 'dd.MM.yyyy HH:mm'}}
                </mat-cell>
              </ng-container>
              <mat-header-row *matHeaderRowDef="displayedColumns;sticky: true"></mat-header-row>
              <mat-row  (click)="onRowClick(row)"
                        *matRowDef="let row; columns: displayedColumns;"></mat-row>
            </mat-table>
          </div>
          <mat-paginator
            [length]="totalRecords"
            [pageSize]="pageSize"
            [pageIndex]="pageIndex"
            [pageSizeOptions]="[50, 100, 200, 500]"
            showFirstLastButtons
            (page)="onPaginatorChange($event)"
          >
          </mat-paginator>
        </div>
      </div>

      <mat-accordion class="accordion">
        <mat-expansion-panel [expanded]="booklets.length === 1" *ngFor="let booklet of booklets" >
          <mat-expansion-panel-header>
            <mat-panel-title (click)="setSelectedBooklet(booklet)">
              {{ booklet.name }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <mat-list class="unit-list">
            <button mat-button (click)="replayBooklet(booklet)">
              <mat-icon>play_arrow</mat-icon>
              Replay
            </button>
            <button mat-button (click)="replayBooklet(booklet)">
              <button mat-button (click)="openBookletLogsDialog(booklet)">
                <mat-icon>list</mat-icon>
                Logs
              </button>
            </button>
            <mat-list-item
              *ngFor="let unit of booklet.units"
              (click)="onUnitClick(unit)"
              class="hoverable">
              <span>{{ unit?.alias }}</span>
            </mat-list-item>
          </mat-list>
        </mat-expansion-panel>
      </mat-accordion>
      <mat-list class="var-list">
        <button mat-button *ngIf="responses.length > 0" (click)="replayUnit()">
          <mat-icon>play_arrow</mat-icon>
          Replay
        </button>
        <mat-list-item
          *ngFor="let response of this.responses"
          class="hoverable"
          [matTooltip]="response.status +
              (response.code ? ' ' + response.code : '') +
              (response.score ? ' ' + response.score : '') +
              ' ' + response.value"
          matTooltipPosition="right"
        >
          <div class="fx-row-start-start">
            <div
              [ngStyle]="{ 'background-color': getColor(response.status) }"
              class="square"
            >
            </div>
            <span >{{ response.variableid }}</span>
          </div>
        </mat-list-item>
      </mat-list>
      <div class="fx-column-start-start log-list">
        @for (log of this.logs; track log;) {
          <div class="fx-row-start-start log-item">
            <strong class="log-key">{{ log.key }}</strong>
            <span class="log-parameter">- {{ log.parameter }}</span>
            <small class="log-timestamp">{{ formatTimestamp(log.ts) }}</small>
          </div>
        }
      </div>

    </div>
  } @else {
    <p>Es sind keine Testergebnisse vorhanden.</p>
  }
}

</div>
